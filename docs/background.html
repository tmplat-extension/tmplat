<!DOCTYPE html>  <html> <head>   <title>background.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="analytics.html">                 analytics.coffee               </a>                                           <a class="source" href="background.html">                 background.coffee               </a>                                           <a class="source" href="content.html">                 content.coffee               </a>                                           <a class="source" href="i18n.html">                 i18n.coffee               </a>                                           <a class="source" href="install.html">                 install.coffee               </a>                                           <a class="source" href="log.html">                 log.coffee               </a>                                           <a class="source" href="notification.html">                 notification.coffee               </a>                                           <a class="source" href="options.html">                 options.coffee               </a>                                           <a class="source" href="popup.html">                 popup.coffee               </a>                                           <a class="source" href="store.html">                 store.coffee               </a>                                           <a class="source" href="utils.html">                 utils.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               background.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><a href="http://neocotic.com/template">Template</a> <br />
(c) 2012 Alasdair Mercer <br />
Freely distributable under the MIT license. <br />
For all details and documentation: <br />
<a href="http://neocotic.com/template">http://neocotic.com/template</a></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Private constants</h2>             </td>             <td class="code">               <div class="highlight"><pre>


</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>List of blacklisted extension IDs that should be prevented from making
external requests to Template.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">BLACKLIST         = </span><span class="p">[]</span>

</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Predefined templates to be used by default.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">DEFAULT_TEMPLATES = </span><span class="p">[</span>
    <span class="nv">content: </span> <span class="s1">&#39;{url}&#39;</span>
    <span class="nv">enabled: </span> <span class="kc">yes</span>
    <span class="nv">image: </span>   <span class="s1">&#39;tmpl_globe&#39;</span>
    <span class="nv">index: </span>   <span class="mi">0</span>
    <span class="nv">key: </span>     <span class="s1">&#39;PREDEFINED.00001&#39;</span>
    <span class="nv">readOnly: </span><span class="kc">yes</span>
    <span class="nv">shortcut: </span><span class="s1">&#39;U&#39;</span>
    <span class="nv">title: </span>   <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;default_template_url&#39;</span>
    <span class="nv">usage: </span>   <span class="mi">0</span>
  <span class="p">,</span>
    <span class="nv">content: </span> <span class="s1">&#39;{#shorten}{url}{/shorten}&#39;</span>
    <span class="nv">enabled: </span> <span class="kc">yes</span>
    <span class="nv">image: </span>   <span class="s1">&#39;tmpl_link&#39;</span>
    <span class="nv">index: </span>   <span class="mi">1</span>
    <span class="nv">key: </span>     <span class="s1">&#39;PREDEFINED.00002&#39;</span>
    <span class="nv">readOnly: </span><span class="kc">yes</span>
    <span class="nv">shortcut: </span><span class="s1">&#39;S&#39;</span>
    <span class="nv">title: </span>   <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;default_template_short&#39;</span>
    <span class="nv">usage: </span>   <span class="mi">0</span>
  <span class="p">,</span>
    <span class="nv">content: </span> <span class="s2">&quot;&lt;a href=\&quot;{{url}}\&quot;{#anchorTarget}</span>
<span class="s2"> target=\&quot;_blank\&quot;{/anchorTarget}{#anchorTitle}</span>
<span class="s2"> title=\&quot;{{title}}\&quot;{/anchorTitle}&gt;{{title}}&lt;/a&gt;&quot;</span>
    <span class="nv">enabled: </span> <span class="kc">yes</span>
    <span class="nv">image: </span>   <span class="s1">&#39;tmpl_html&#39;</span>
    <span class="nv">index: </span>   <span class="mi">2</span>
    <span class="nv">key: </span>     <span class="s1">&#39;PREDEFINED.00003&#39;</span>
    <span class="nv">readOnly: </span><span class="kc">yes</span>
    <span class="nv">shortcut: </span><span class="s1">&#39;A&#39;</span>
    <span class="nv">title: </span>   <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;default_template_anchor&#39;</span>
    <span class="nv">usage: </span>   <span class="mi">0</span>
  <span class="p">,</span>
    <span class="nv">content: </span> <span class="s1">&#39;{#encode}{url}{/encode}&#39;</span>
    <span class="nv">enabled: </span> <span class="kc">yes</span>
    <span class="nv">image: </span>   <span class="s1">&#39;tmpl_component&#39;</span>
    <span class="nv">index: </span>   <span class="mi">3</span>
    <span class="nv">key: </span>     <span class="s1">&#39;PREDEFINED.00004&#39;</span>
    <span class="nv">readOnly: </span><span class="kc">yes</span>
    <span class="nv">shortcut: </span><span class="s1">&#39;E&#39;</span>
    <span class="nv">title: </span>   <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;default_template_encoded&#39;</span>
    <span class="nv">usage: </span>   <span class="mi">0</span>
  <span class="p">,</span>
    <span class="nv">content: </span> <span class="s1">&#39;[url={url}]{title}[/url]&#39;</span>
    <span class="nv">enabled: </span> <span class="kc">no</span>
    <span class="nv">image: </span>   <span class="s1">&#39;tmpl_discussion&#39;</span>
    <span class="nv">index: </span>   <span class="mi">5</span>
    <span class="nv">key: </span>     <span class="s1">&#39;PREDEFINED.00005&#39;</span>
    <span class="nv">readOnly: </span><span class="kc">yes</span>
    <span class="nv">shortcut: </span><span class="s1">&#39;B&#39;</span>
    <span class="nv">title: </span>   <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;default_template_bbcode&#39;</span>
    <span class="nv">usage: </span>   <span class="mi">0</span>
  <span class="p">,</span>
    <span class="nv">content: </span> <span class="s1">&#39;[{title}]({url})&#39;</span>
    <span class="nv">enabled: </span> <span class="kc">no</span>
    <span class="nv">image: </span>   <span class="s1">&#39;tmpl_discussion&#39;</span>
    <span class="nv">index: </span>   <span class="mi">4</span>
    <span class="nv">key: </span>     <span class="s1">&#39;PREDEFINED.00006&#39;</span>
    <span class="nv">readOnly: </span><span class="kc">yes</span>
    <span class="nv">shortcut: </span><span class="s1">&#39;M&#39;</span>
    <span class="nv">title: </span>   <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;default_template_markdown&#39;</span>
    <span class="nv">usage: </span>   <span class="mi">0</span>
<span class="p">]</span>

</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Extension ID being used by Template.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">EXTENSION_ID      = </span><span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;@@extension_id&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Domain of this extension's homepage.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">HOMEPAGE_DOMAIN   = </span><span class="s1">&#39;neocotic.com&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>List of known operating systems that could be used by the user.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">OPERATING_SYSTEMS = </span><span class="p">[</span>
  <span class="nv">substring: </span><span class="s1">&#39;Win&#39;</span>
  <span class="nv">title: </span>    <span class="s1">&#39;Windows&#39;</span>
<span class="p">,</span>
  <span class="nv">substring: </span><span class="s1">&#39;Mac&#39;</span>
  <span class="nv">title: </span>    <span class="s1">&#39;Mac&#39;</span>
<span class="p">,</span>
  <span class="nv">substring: </span><span class="s1">&#39;Linux&#39;</span>
  <span class="nv">title: </span>    <span class="s1">&#39;Linux&#39;</span>
<span class="p">]</span>

</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Milliseconds before the popup automatically resets or closes, depending on
user preferences.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">POPUP_DELAY       = </span><span class="mi">600</span>

</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Regular expression used to detect upper case characters.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">R_UPPER_CASE      = </span><span class="sr">/[A-Z]+/</span>

</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Regular expression used to perform simple URL validation.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">R_VALID_URL       = </span><span class="sr">/^https?:\/\/\S+\.\S+/i</span>

</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Extension ID of the production version of Template.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">REAL_EXTENSION_ID = </span><span class="s1">&#39;dcjnfaoifoefmnbhhlbppaebgnccfddf&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>List of URL shortener services supported by Template.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">SHORTENERS        = </span><span class="p">[</span>

</pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Setup <a href="http://bit.ly">bitly</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">contentType: </span>  <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span>
  <span class="nv">getParameters: </span><span class="nf">(url) -&gt;</span>
    <span class="nv">bitly  = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;bitly&#39;</span>
    <span class="nv">params =</span>
      <span class="nv">apiKey: </span> <span class="s1">&#39;R_91eabef2f32d88c07b197c9d69eed516&#39;</span>
      <span class="nv">format: </span> <span class="s1">&#39;json&#39;</span>
      <span class="nv">login: </span>  <span class="s1">&#39;templateextension&#39;</span>
      <span class="nv">longUrl: </span><span class="nx">url</span>
    <span class="k">if</span> <span class="nx">bitly</span><span class="p">.</span><span class="nx">apiKey</span> <span class="o">and</span> <span class="nx">bitly</span><span class="p">.</span><span class="nx">username</span>
      <span class="nv">params.x_apiKey = </span><span class="nx">bitly</span><span class="p">.</span><span class="nx">apiKey</span>
      <span class="nv">params.x_login  = </span><span class="nx">bitly</span><span class="p">.</span><span class="nx">username</span>
    <span class="nx">params</span>
  <span class="nv">getUsage: </span>     <span class="o">-&gt;</span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;bitly.usage&#39;</span>
  <span class="nv">input: </span>        <span class="o">-&gt;</span> <span class="kc">null</span>
  <span class="nv">isEnabled: </span>    <span class="o">-&gt;</span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;bitly.enabled&#39;</span>
  <span class="nv">method: </span>       <span class="s1">&#39;GET&#39;</span>
  <span class="nv">name: </span>         <span class="s1">&#39;bitly&#39;</span>
  <span class="nv">output: </span>       <span class="nf">(resp) -&gt;</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">resp</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">url</span>
  <span class="nv">title: </span>        <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;shortener_bitly&#39;</span>
  <span class="nv">url: </span>          <span class="o">-&gt;</span> <span class="s1">&#39;http://api.bitly.com/v3/shorten&#39;</span>
<span class="p">,</span>

</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Setup <a href="http://goo.gl">Google URL Shortener</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">contentType: </span>  <span class="s1">&#39;application/json&#39;</span>
  <span class="nv">getParameters: </span><span class="o">-&gt;</span> <span class="nv">key: </span><span class="s1">&#39;AIzaSyD504IwHeL3V2aw6ZGYQRgwWnJ38jNl2MY&#39;</span>
  <span class="nv">getUsage: </span>     <span class="o">-&gt;</span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;googl.usage&#39;</span>
  <span class="nv">input: </span>        <span class="nf">(url) -&gt;</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nv">longUrl: </span><span class="nx">url</span>
  <span class="nv">isEnabled: </span>    <span class="o">-&gt;</span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;googl.enabled&#39;</span>
  <span class="nv">method: </span>       <span class="s1">&#39;POST&#39;</span>
  <span class="nv">name: </span>         <span class="s1">&#39;googl&#39;</span>
  <span class="nv">oauth: </span>        <span class="nx">ChromeExOAuth</span><span class="p">.</span><span class="nx">initBackgroundPage</span>
    <span class="nv">access_url: </span>     <span class="s1">&#39;https://www.google.com/accounts/OAuthGetAccessToken&#39;</span>
    <span class="nv">app_name: </span>       <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;app_name&#39;</span>
    <span class="nv">authorize_url: </span>  <span class="s1">&#39;https://www.google.com/accounts/OAuthAuthorizeToken&#39;</span>
    <span class="nv">consumer_key: </span>   <span class="s1">&#39;anonymous&#39;</span>
    <span class="nv">consumer_secret: </span><span class="s1">&#39;anonymous&#39;</span>
    <span class="nv">request_url: </span>    <span class="s1">&#39;https://www.google.com/accounts/OAuthGetRequestToken&#39;</span>
    <span class="nv">scope: </span>          <span class="s1">&#39;https://www.googleapis.com/auth/urlshortener&#39;</span>
  <span class="nv">output: </span>       <span class="nf">(resp) -&gt;</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">resp</span><span class="p">).</span><span class="nx">id</span>
  <span class="nv">title: </span>        <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;shortener_googl&#39;</span>
  <span class="nv">url: </span>          <span class="o">-&gt;</span> <span class="s1">&#39;https://www.googleapis.com/urlshortener/v1/url&#39;</span>
<span class="p">,</span>

</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Setup <a href="http://yourls.org">YOURLS</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">contentType: </span>  <span class="s1">&#39;application/json&#39;</span>
  <span class="nv">getParameters: </span><span class="nf">(url) -&gt;</span>
    <span class="nv">params =</span>
      <span class="nv">action: </span><span class="s1">&#39;shorturl&#39;</span>
      <span class="nv">format: </span><span class="s1">&#39;json&#39;</span>
      <span class="nv">url: </span>   <span class="nx">url</span>
    <span class="nv">yourls = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;yourls&#39;</span>
    <span class="k">if</span> <span class="nx">yourls</span><span class="p">.</span><span class="nx">password</span> <span class="o">and</span> <span class="nx">yourls</span><span class="p">.</span><span class="nx">username</span>
      <span class="nv">params.password  = </span><span class="nx">yourls</span><span class="p">.</span><span class="nx">password</span>
      <span class="nv">params.username  = </span><span class="nx">yourls</span><span class="p">.</span><span class="nx">username</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">yourls</span><span class="p">.</span><span class="nx">signature</span>
      <span class="nv">params.signature = </span><span class="nx">yourls</span><span class="p">.</span><span class="nx">signature</span>
    <span class="nx">params</span>
  <span class="nv">getUsage: </span>     <span class="o">-&gt;</span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;yourls.usage&#39;</span>
  <span class="nv">input: </span>        <span class="o">-&gt;</span> <span class="kc">null</span>
  <span class="nv">isEnabled: </span>    <span class="o">-&gt;</span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;yourls.enabled&#39;</span>
  <span class="nv">method: </span>       <span class="s1">&#39;POST&#39;</span>
  <span class="nv">name: </span>         <span class="s1">&#39;yourls&#39;</span>
  <span class="nv">output: </span>       <span class="nf">(resp) -&gt;</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">resp</span><span class="p">).</span><span class="nx">shorturl</span>
  <span class="nv">title: </span>        <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;shortener_yourls&#39;</span>
  <span class="nv">url: </span>          <span class="o">-&gt;</span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;yourls.url&#39;</span>
<span class="p">]</span>

</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>List of extensions supported by Template and used for compatibility purposes.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">SUPPORT           = </span><span class="p">[</span>

</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Setup <a href="http://ietab.net">IE Tab</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">id: </span>   <span class="s1">&#39;hehijbfgiekmjfkfjpbkbammjbdenadd&#39;</span>
  <span class="nv">title: </span><span class="nf">(title) -&gt;</span>
    <span class="nv">str = </span><span class="s1">&#39;IE: &#39;</span>
    <span class="k">if</span> <span class="nx">title</span>
      <span class="nv">idx   = </span><span class="nx">title</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">str</span>
      <span class="nv">title = </span><span class="nx">title</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">idx</span> <span class="o">+</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span> <span class="k">if</span> <span class="nx">idx</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
    <span class="nx">title</span>
  <span class="nv">url: </span>  <span class="nf">(url) -&gt;</span>
    <span class="nv">str = </span><span class="s1">&#39;iecontainer.html#url=&#39;</span>
    <span class="k">if</span> <span class="nx">url</span>
      <span class="nv">idx = </span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">str</span>
      <span class="nv">url = </span><span class="nb">decodeURIComponent</span> <span class="nx">url</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">idx</span> <span class="o">+</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span> <span class="k">if</span> <span class="nx">idx</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
    <span class="nx">url</span>
<span class="p">,</span>

</pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Setup <a href="http://goo.gl/u7Cau">IE Tab Classic</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">id: </span>   <span class="s1">&#39;miedgcmlgpmdagojnnbemlkgidepfjfi&#39;</span>
  <span class="nv">title: </span><span class="nf">(title) -&gt;</span> <span class="nx">title</span>
  <span class="nv">url: </span>  <span class="nf">(url) -&gt;</span>
    <span class="nv">str = </span><span class="s1">&#39;ie.html#&#39;</span>
    <span class="k">if</span> <span class="nx">url</span>
      <span class="nv">idx = </span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">str</span>
      <span class="nv">url = </span><span class="nx">url</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">idx</span> <span class="o">+</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span> <span class="k">if</span> <span class="nx">idx</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
    <span class="nx">url</span>
<span class="p">,</span>

</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Setup <a href="http://iblogbox.com/chrome/ietab">IE Tab Multi (Enhance)</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">id: </span>   <span class="s1">&#39;fnfnbeppfinmnjnjhedifcfllpcfgeea&#39;</span>
  <span class="nv">title: </span><span class="nf">(title) -&gt;</span> <span class="nx">title</span>
  <span class="nv">url: </span>  <span class="nf">(url) -&gt;</span>
    <span class="nv">str = </span><span class="s1">&#39;navigate.html?chromeurl=&#39;</span>
    <span class="k">if</span> <span class="nx">url</span>
      <span class="nv">idx = </span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">str</span>
      <span class="k">if</span> <span class="nx">idx</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nv">url = </span><span class="nx">url</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">idx</span> <span class="o">+</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span>
        <span class="nv">str = </span><span class="s1">&#39;[escape]&#39;</span>
        <span class="k">if</span> <span class="nx">url</span> <span class="o">and</span> <span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="o">is</span> <span class="mi">0</span>
          <span class="nv">url = </span><span class="nb">decodeURIComponent</span> <span class="nx">url</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">url</span>
<span class="p">,</span>

</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Setup <a href="http://iblogbox.com/chrome/geckotab">Mozilla Gecko Tab</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">id: </span>   <span class="s1">&#39;icoloanbecehinobmflpeglknkplbfbm&#39;</span>
  <span class="nv">title: </span><span class="nf">(title) -&gt;</span> <span class="nx">title</span>
  <span class="nv">url: </span>  <span class="nf">(url) -&gt;</span>
    <span class="nv">str = </span><span class="s1">&#39;navigate.html?chromeurl=&#39;</span>
    <span class="k">if</span> <span class="nx">url</span>
      <span class="nv">idx = </span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">str</span>
      <span class="k">if</span> <span class="nx">idx</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nv">url = </span><span class="nx">url</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">idx</span> <span class="o">+</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span>
        <span class="nv">str = </span><span class="s1">&#39;[escape]&#39;</span>
        <span class="k">if</span> <span class="nx">url</span> <span class="o">and</span> <span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="o">is</span> <span class="mi">0</span>
          <span class="nv">url = </span><span class="nb">decodeURIComponent</span> <span class="nx">url</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">url</span>
<span class="p">]</span>


</pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <h2>Private variables</h2>             </td>             <td class="code">               <div class="highlight"><pre>


</pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Details of the current browser.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">browser           =</span>
  <span class="nv">title: </span>  <span class="s1">&#39;Chrome&#39;</span>
  <span class="nv">version: </span><span class="s1">&#39;&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Indicate whether or not Template has just been installed.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">isNewInstall      = </span><span class="kc">no</span>

</pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Indicate whether or not Template is currently running the production build.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">isProductionBuild = </span><span class="nx">EXTENSION_ID</span> <span class="o">is</span> <span class="nx">REAL_EXTENSION_ID</span>

</pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Name of the user's operating system.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">operatingSystem   = </span><span class="s1">&#39;&#39;</span>


</pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h2>Private functions</h2>             </td>             <td class="code">               <div class="highlight"><pre>


</pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Inject and execute the <code>content.coffee</code> and <code>install.coffee</code> scripts within
all of the tabs (where valid) of each Chrome window.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">executeScriptsInExistingWindows = </span><span class="o">-&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Create a runner to help manage the asynchronous aspect.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">runner = </span><span class="k">new</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">Runner</span><span class="p">()</span>
  <span class="nx">runner</span><span class="p">.</span><span class="nx">push</span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">windows</span><span class="p">,</span> <span class="s1">&#39;getAll&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nf">(windows) -&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="s1">&#39;Retrieved the following windows...&#39;</span><span class="p">,</span> <span class="nx">windows</span>
    <span class="k">for</span> <span class="nx">win</span> <span class="k">in</span> <span class="nx">windows</span>
      <span class="nx">do</span> <span class="nf">(win) -&gt;</span> <span class="nx">runner</span><span class="p">.</span><span class="nx">push</span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">tabs</span><span class="p">,</span> <span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="nv">windowId: </span><span class="nx">win</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nf">(tabs) -&gt;</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="s1">&#39;Retrieved the following tabs...&#39;</span><span class="p">,</span> <span class="nx">tabs</span>

</pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Check tabs are not displaying a <em>protected</em> page (i.e. one that
will cause an error if an attempt is made to execute content
scripts).</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">for</span> <span class="nx">tab</span> <span class="k">in</span> <span class="nx">tabs</span> <span class="k">when</span> <span class="o">not</span> <span class="nx">isProtectedPage</span> <span class="nx">tab</span>
          <span class="nx">chrome</span><span class="p">.</span><span class="nx">tabs</span><span class="p">.</span><span class="nx">executeScript</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nv">file: </span><span class="s1">&#39;lib/content.js&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Only execute inline installation content script for tabs
displaying a page on Template's homepage domain.</p>             </td>             <td class="code">               <div class="highlight"><pre>
          <span class="k">if</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">HOMEPAGE_DOMAIN</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
            <span class="nx">chrome</span><span class="p">.</span><span class="nx">tabs</span><span class="p">.</span><span class="nx">executeScript</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nv">file: </span><span class="s1">&#39;lib/install.js&#39;</span>
        <span class="nx">runner</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
    <span class="nx">runner</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
  <span class="nx">runner</span><span class="p">.</span><span class="nx">run</span><span class="p">()</span>


</pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Attempt to derive the current version of the user's browser.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">getBrowserVersion = </span><span class="o">-&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nv">str = </span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span>
  <span class="nv">idx = </span><span class="nx">str</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">title</span>
  <span class="k">if</span> <span class="nx">idx</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
    <span class="nv">str = </span><span class="nx">str</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">idx</span> <span class="o">+</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nv">idx = </span><span class="nx">str</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s1">&#39; &#39;</span>
    <span class="k">if</span> <span class="nx">idx</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="nx">str</span> <span class="k">else</span> <span class="nx">str</span><span class="p">.</span><span class="nx">substring</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">idx</span>


</pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Derive the path of the image used by <code>template</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">getImagePathForTemplate = </span><span class="nf">(template, relative) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nv">path = </span><span class="k">if</span> <span class="nx">relative</span> <span class="k">then</span> <span class="s1">&#39;../&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
  <span class="k">for</span> <span class="nx">image</span> <span class="k">in</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">IMAGES</span> <span class="k">when</span> <span class="nx">image</span> <span class="o">is</span> <span class="nx">template</span><span class="p">.</span><span class="nx">image</span>
    <span class="nx">path</span> <span class="o">+=</span> <span class="s2">&quot;images/#{image}.png&quot;</span>
    <span class="k">break</span>
  <span class="nx">path</span> <span class="o">+=</span> <span class="s1">&#39;images/spacer.gif&#39;</span> <span class="k">if</span> <span class="nx">path</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">3</span>
  <span class="nx">path</span>


</pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Derive the operating system being used by the user.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">getOperatingSystem = </span><span class="o">-&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nv">str = </span><span class="nx">navigator</span><span class="p">.</span><span class="nx">platform</span>
  <span class="k">for</span> <span class="nx">os</span> <span class="k">in</span> <span class="nx">OPERATING_SYSTEMS</span> <span class="k">when</span> <span class="nx">str</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">substring</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
    <span class="nv">str = </span><span class="nx">os</span><span class="p">.</span><span class="nx">title</span>
    <span class="k">break</span>
  <span class="nx">str</span>


</pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Attempt to retrieve the template with the specified <code>key</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">getTemplateWithKey = </span><span class="nf">(key) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nx">ext</span><span class="p">.</span><span class="nx">queryTemplate</span> <span class="nf">(template) -&gt;</span> <span class="nx">template</span><span class="p">.</span><span class="nx">key</span> <span class="o">is</span> <span class="nx">key</span>


</pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Attempt to retrieve the template with the specified <code>menuId</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">getTemplateWithMenuId = </span><span class="nf">(menuId) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nx">ext</span><span class="p">.</span><span class="nx">queryTemplate</span> <span class="nf">(template) -&gt;</span> <span class="nx">template</span><span class="p">.</span><span class="nx">menuId</span> <span class="o">is</span> <span class="nx">menuId</span>


</pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Attempt to retrieve the template with the specified keyboard <code>shortcut</code>. <br />
Exclude disabled templates from this query.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">getTemplateWithShortcut = </span><span class="nf">(shortcut) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nx">ext</span><span class="p">.</span><span class="nx">queryTemplate</span> <span class="nf">(template) -&gt;</span>
    <span class="nx">template</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">and</span> <span class="nx">template</span><span class="p">.</span><span class="nx">shortcut</span> <span class="o">is</span> <span class="nx">shortcut</span>


</pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Determine whether or not the specified extension is blacklisted.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">isBlacklisted = </span><span class="nf">(extensionId) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="k">return</span> <span class="kc">yes</span> <span class="k">for</span> <span class="nx">extension</span> <span class="k">in</span> <span class="nx">BLACKLIST</span> <span class="k">when</span> <span class="nx">extension</span> <span class="o">is</span> <span class="nx">extensionId</span>
  <span class="kc">no</span>


</pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Determine whether or not the specified extension is active on <code>tab</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">isExtensionActive = </span><span class="nf">(tab, extensionId) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;Checking activity of #{extensionId}&quot;</span>
  <span class="nx">isSpecialPage</span><span class="p">(</span><span class="nx">tab</span><span class="p">)</span> <span class="o">and</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">extensionId</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>


</pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Determine whether or not <code>tab</code> is currently displaying a page on the Chrome
Extension Gallery (i.e. Web Store).</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">isExtensionGallery = </span><span class="nf">(tab) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nx">tab</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;https://chrome.google.com/webstore&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="mi">0</span>


</pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Determine whether or not <code>tab</code> is currently displaying a <em>protected</em> page
(i.e. a page that content scripts cannot be executed on).</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">isProtectedPage = </span><span class="nf">(tab) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nx">isSpecialPage</span><span class="p">(</span><span class="nx">tab</span><span class="p">)</span> <span class="o">or</span> <span class="nx">isExtensionGallery</span> <span class="nx">tab</span>


</pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Determine whether or not <code>tab</code> is currently displaying a <em>special</em> page (i.e.
a page that is internal to the browser).</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">isSpecialPage = </span><span class="nf">(tab) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nx">tab</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;chrome&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="mi">0</span>


</pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Ensure <code>null</code> is returned instead of <code>object</code> if it is <em>empty</em>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">nullIfEmpty = </span><span class="nf">(object) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isEmptyObject</span> <span class="nx">object</span> <span class="k">then</span> <span class="kc">null</span> <span class="k">else</span> <span class="nx">object</span>


</pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Listener for internal requests to the extension. <br />
External requests are also routed through here, but only after being checked
that they do not originate from a blacklisted extension.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">onRequest = </span><span class="nf">(request, sender, sendResponse) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Don't allow shortcut requests when shortcuts are disabled.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">if</span> <span class="nx">request</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s1">&#39;shortcut&#39;</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;shortcuts&#39;</span>
    <span class="k">return</span> <span class="nx">sendResponse</span><span class="o">?</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Select or create a tab for the Options page.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">if</span> <span class="nx">request</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s1">&#39;options&#39;</span>
    <span class="nx">selectOrCreateTab</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">url</span> <span class="s1">&#39;pages/options.html&#39;</span>
    <span class="k">return</span> <span class="nx">sendResponse</span><span class="o">?</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Info requests are simple, just send some useful information back. Done!</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">if</span> <span class="nx">request</span><span class="p">.</span><span class="nx">type</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">sendResponse</span><span class="o">?</span> <span class="nv">id: </span><span class="nx">EXTENSION_ID</span><span class="p">,</span> <span class="nv">version: </span><span class="nx">ext</span><span class="p">.</span><span class="nx">version</span>
  <span class="nv">data       = </span><span class="kc">null</span>
  <span class="nv">output     = </span><span class="kc">null</span>
  <span class="nv">shortenMap = </span><span class="p">{}</span>
  <span class="nv">tab        = </span><span class="kc">null</span>
  <span class="nv">template   = </span><span class="kc">null</span>
  <span class="nv">windowId   = </span><span class="kc">null</span>

</pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Create a runner to manage this asynchronous mess.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">runner = </span><span class="k">new</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">Runner</span><span class="p">()</span>
  <span class="nx">runner</span><span class="p">.</span><span class="nx">push</span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">windows</span><span class="p">,</span> <span class="s1">&#39;getCurrent&#39;</span><span class="p">,</span> <span class="nf">(win) -&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="s1">&#39;Retrieved the following window...&#39;</span><span class="p">,</span> <span class="nx">win</span>
    <span class="nv">windowId = </span><span class="nx">win</span><span class="p">.</span><span class="nx">id</span>
    <span class="nx">runner</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
  <span class="nx">runner</span><span class="p">.</span><span class="nx">pushPacked</span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">tabs</span><span class="p">,</span> <span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nv">active: </span><span class="kc">yes</span><span class="p">,</span> <span class="nv">windowId: </span><span class="nx">windowId</span><span class="p">,</span> <span class="nf">(tabs) -&gt;</span>
      <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="s1">&#39;Retrieved the following tabs...&#39;</span><span class="p">,</span> <span class="nx">tabs</span>
      <span class="nv">tab = </span><span class="nx">tabs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">runner</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
    <span class="p">]</span>
  <span class="nx">runner</span><span class="p">.</span><span class="nx">push</span> <span class="kc">null</span><span class="p">,</span> <span class="o">-&gt;</span>

</pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Called whenever the <code>shorten</code> (or previously <code>short</code>) tag is found to
indicate that a URL needs shortened. <br />
Replace the tag with the unique placeholder so that it can be rendered
again later with the short URL.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">shortCallback = </span><span class="nf">(text, render) -&gt;</span>
      <span class="nv">text = </span><span class="k">if</span> <span class="nx">text</span> <span class="k">then</span> <span class="nx">render</span> <span class="nx">text</span> <span class="k">else</span> <span class="nx">@url</span>
      <span class="nv">url  = </span><span class="nx">text</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span>
      <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s1">&#39;Following is the contents of a shorten tag...&#39;</span><span class="p">,</span> <span class="nx">text</span>

</pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>If <code>url</code> doesn't appear to be a valid URL so just return the rendered
<code>text</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">return</span> <span class="nx">text</span> <span class="nx">unless</span> <span class="nx">R_VALID_URL</span><span class="p">.</span><span class="nx">test</span> <span class="nx">url</span>
      <span class="nv">placeholder = </span><span class="nx">key</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">shortenMap</span> <span class="k">when</span> <span class="nx">value</span> <span class="o">is</span> <span class="nx">url</span>
      <span class="nx">unless</span> <span class="nx">placeholder</span><span class="o">?</span>
        <span class="nv">placeholder = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">keyGen</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="kc">no</span>
        <span class="nx">shortenMap</span><span class="p">[</span><span class="nx">placeholder</span><span class="p">]</span> <span class="o">=</span> <span class="nx">url</span>

</pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Sections are re-rendered so the context must have a property for the
placeholder the replaces itself with itself so that it still when it
comes to replacing with the shortened URL.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">this</span><span class="p">[</span><span class="nx">placeholder</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;{#{placeholder}}&quot;</span>
      <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;Replacing shorten tag with #{placeholder} placeholder&quot;</span>
      <span class="s2">&quot;{#{placeholder}}&quot;</span>

</pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>If the popup is currently displayed, hide the template list and show a
loading animation.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">updateProgress</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">on</span>

</pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Attempt to derive the contextual template data.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">try</span>
      <span class="k">switch</span> <span class="nx">request</span><span class="p">.</span><span class="nx">type</span>
        <span class="k">when</span> <span class="s1">&#39;menu&#39;</span>
          <span class="nv">data     = </span><span class="nx">buildDerivedData</span> <span class="nx">tab</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">shortCallback</span>
          <span class="nv">template = </span><span class="nx">getTemplateWithMenuId</span> <span class="nx">request</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">menuItemId</span>
        <span class="k">when</span> <span class="s1">&#39;popup&#39;</span><span class="p">,</span> <span class="s1">&#39;toolbar&#39;</span>
          <span class="nv">data     = </span><span class="nx">buildStandardData</span> <span class="nx">tab</span><span class="p">,</span> <span class="nx">shortCallback</span>
          <span class="nv">template = </span><span class="nx">getTemplateWithKey</span> <span class="nx">request</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">key</span>
        <span class="k">when</span> <span class="s1">&#39;shortcut&#39;</span>
          <span class="nv">data     = </span><span class="nx">buildStandardData</span> <span class="nx">tab</span><span class="p">,</span> <span class="nx">shortCallback</span>
          <span class="nv">template = </span><span class="nx">getTemplateWithShortcut</span> <span class="nx">request</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">key</span>
      <span class="nx">updateProgress</span> <span class="mi">20</span>
      <span class="k">if</span> <span class="nx">data</span><span class="o">?</span> <span class="o">and</span> <span class="nx">template</span><span class="o">?</span> <span class="k">then</span> <span class="nx">runner</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span> <span class="k">else</span> <span class="nx">runner</span><span class="p">.</span><span class="nx">finish</span><span class="p">()</span>
    <span class="k">catch</span> <span class="nx">error</span>
      <span class="nx">log</span><span class="p">.</span><span class="nx">error</span> <span class="nx">error</span>

</pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Oops! Something went wrong so we should probably let the user know.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">runner</span><span class="p">.</span><span class="nx">finish</span>
        <span class="nv">message: </span><span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="k">if</span> <span class="nx">error</span> <span class="k">instanceof</span> <span class="nx">URIError</span>
          <span class="s1">&#39;result_bad_uri_description&#39;</span>
        <span class="k">else</span>
          <span class="s1">&#39;result_bad_error_description&#39;</span>
        <span class="nv">success: </span><span class="kc">no</span>
  <span class="nx">runner</span><span class="p">.</span><span class="nx">pushPacked</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">addAdditionalData</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nx">tab</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">updateProgress</span> <span class="mi">40</span>

</pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Ensure all properties of <code>data</code> are lower case.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">transformData</span> <span class="nx">data</span>

</pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>To complete the data, simply extend it using <code>template</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">data</span><span class="p">,</span> <span class="nv">template: </span><span class="nx">template</span>
      <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;Using the following data to render #{template.title}...&quot;</span><span class="p">,</span> <span class="nx">data</span>
      <span class="k">if</span> <span class="nx">template</span><span class="p">.</span><span class="nx">content</span>
        <span class="nv">output = </span><span class="nx">Mustache</span><span class="p">.</span><span class="nx">to_html</span> <span class="nx">template</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span> <span class="nx">data</span>
        <span class="nx">updateProgress</span> <span class="mi">60</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s1">&#39;Following string is the rendered result...&#39;</span><span class="p">,</span> <span class="nx">output</span>

</pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>If any <code>shorten</code> (or old <code>short</code>) tags are found and replaced, the
URL shortener service needs to be called in order to replace any
placeholders with their corresponding short URL.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isEmptyObject</span> <span class="nx">shortenMap</span>
          <span class="nx">runner</span><span class="p">.</span><span class="nx">finish</span>
            <span class="nv">contents: </span><span class="nx">output</span>
            <span class="nv">success: </span> <span class="kc">yes</span>
            <span class="nv">template: </span><span class="nx">template</span>
        <span class="k">else</span>
          <span class="nx">runner</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
      <span class="k">else</span>

</pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Display the <em>empty contents</em> error message if the contents of the
template itself is empty.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="nx">runner</span><span class="p">.</span><span class="nx">finish</span>
          <span class="nv">contents: </span><span class="s1">&#39;&#39;</span>
          <span class="nv">success: </span> <span class="kc">yes</span>
          <span class="nv">template: </span><span class="nx">template</span>
    <span class="p">]</span>
  <span class="nx">runner</span><span class="p">.</span><span class="nx">push</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">callUrlShortener</span><span class="p">,</span> <span class="nx">shortenMap</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="s1">&#39;URL shortener service was called one or more times&#39;</span>
    <span class="nx">updateProgress</span> <span class="mi">80</span>
    <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">success</span>
      <span class="nx">updateUrlShortenerUsage</span> <span class="nx">response</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">oauth</span>

</pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Request to the URL shortener service was successful so re-render the
output.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nv">newOutput = </span><span class="nx">Mustache</span><span class="p">.</span><span class="nx">to_html</span> <span class="nx">output</span><span class="p">,</span> <span class="nx">shortenMap</span>
      <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s1">&#39;Following string is the re-rendered result...&#39;</span><span class="p">,</span> <span class="nx">newOutput</span>
      <span class="nx">runner</span><span class="p">.</span><span class="nx">finish</span>
        <span class="nv">contents: </span><span class="nx">newOutput</span>
        <span class="nv">success: </span> <span class="kc">yes</span>
        <span class="nv">template: </span><span class="nx">template</span>
    <span class="k">else</span>

</pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Aw man, something went wrong. Let the user down gently.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">response</span><span class="p">.</span><span class="nx">message</span> <span class="o">?=</span> <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;shortener_error&#39;</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">service</span><span class="p">.</span><span class="nx">title</span>
      <span class="nx">log</span><span class="p">.</span><span class="nx">warn</span> <span class="nx">response</span><span class="p">.</span><span class="nx">message</span>
      <span class="nx">runner</span><span class="p">.</span><span class="nx">finish</span>
        <span class="nv">message: </span> <span class="nx">response</span><span class="p">.</span><span class="nx">message</span>
        <span class="nv">success: </span> <span class="kc">no</span>
        <span class="nv">template: </span><span class="nx">template</span>
  <span class="nx">runner</span><span class="p">.</span><span class="nx">run</span> <span class="nf">(result) -&gt;</span>
    <span class="nv">type  = </span><span class="nx">request</span><span class="p">.</span><span class="nx">type</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">substr</span> <span class="mi">1</span>
    <span class="nv">value = </span><span class="nx">request</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">charCodeAt</span> <span class="mi">0</span> <span class="k">if</span> <span class="nx">request</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s1">&#39;shortcut&#39;</span>
    <span class="nx">analytics</span><span class="p">.</span><span class="nx">track</span> <span class="s1">&#39;Requests&#39;</span><span class="p">,</span> <span class="s1">&#39;Processed&#39;</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">value</span>
    <span class="nx">updateProgress</span> <span class="mi">100</span>
    <span class="k">if</span> <span class="nx">result</span><span class="o">?</span>

</pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Ensure that the user is notified if they have attempted to copy an
empty string to the system clipboard.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">if</span> <span class="nx">result</span><span class="p">.</span><span class="nx">success</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">result</span><span class="p">.</span><span class="nx">contents</span>
        <span class="nv">result.message = </span><span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;result_bad_empty_description&#39;</span><span class="p">,</span>
          <span class="nx">result</span><span class="p">.</span><span class="nx">template</span><span class="p">.</span><span class="nx">title</span>
        <span class="nv">result.success = </span><span class="kc">no</span>
      <span class="k">if</span> <span class="nx">result</span><span class="p">.</span><span class="nx">success</span>
        <span class="nv">ext.notification.title       = </span><span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;result_good_title&#39;</span>
        <span class="nv">ext.notification.titleStyle  = </span><span class="s1">&#39;color: #050&#39;</span>
        <span class="nv">ext.notification.description = </span><span class="nx">result</span><span class="p">.</span><span class="nx">message</span> <span class="o">?</span>
          <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;result_good_description&#39;</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">template</span><span class="p">.</span><span class="nx">title</span>
        <span class="nx">ext</span><span class="p">.</span><span class="nx">copy</span> <span class="nx">result</span><span class="p">.</span><span class="nx">contents</span>
        <span class="nx">sendResponse</span><span class="o">?</span> <span class="nv">contents: </span><span class="nx">result</span><span class="p">.</span><span class="nx">contents</span>
      <span class="k">else</span>
        <span class="nv">ext.notification.title       = </span><span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;result_bad_title&#39;</span>
        <span class="nv">ext.notification.titleStyle  = </span><span class="s1">&#39;color: #A00&#39;</span>
        <span class="nv">ext.notification.description = </span><span class="nx">result</span><span class="p">.</span><span class="nx">message</span> <span class="o">?</span>
          <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;result_bad_description&#39;</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">template</span><span class="p">.</span><span class="nx">title</span>
        <span class="nx">showNotification</span><span class="p">()</span>
        <span class="nx">sendResponse</span><span class="o">?</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">result</span><span class="p">.</span><span class="nx">template</span><span class="o">?</span>
        <span class="nx">updateTemplateUsage</span> <span class="nx">result</span><span class="p">.</span><span class="nx">template</span><span class="p">.</span><span class="nx">key</span>
        <span class="nx">updateStatistics</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nx">updateProgress</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">off</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;Finished handling #{type} request&quot;</span>


</pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Attempt to select a tab in the current window displaying a page whose
location begins with <code>url</code>. <br />
If no existing tab exists a new one is simply created.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">selectOrCreateTab = </span><span class="nf">(url, callback) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nv">tab      = </span><span class="kc">null</span>
  <span class="nv">windowId = </span><span class="kc">null</span>

</pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Create a runner to mange the asynchronous pattern.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">runner = </span><span class="k">new</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">Runner</span><span class="p">()</span>
  <span class="nx">runner</span><span class="p">.</span><span class="nx">push</span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">windows</span><span class="p">,</span> <span class="s1">&#39;getCurrent&#39;</span><span class="p">,</span> <span class="nf">(win) -&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s1">&#39;Retrieved the following window...&#39;</span><span class="p">,</span> <span class="nx">win</span>
    <span class="nv">windowId = </span><span class="nx">win</span><span class="p">.</span><span class="nx">id</span>
    <span class="nx">runner</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
  <span class="nx">runner</span><span class="p">.</span><span class="nx">pushPacked</span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">tabs</span><span class="p">,</span> <span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nv">windowId: </span><span class="nx">windowId</span><span class="p">,</span> <span class="nf">(tabs) -&gt;</span>
      <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s1">&#39;Retrieved the following tabs...&#39;</span><span class="p">,</span> <span class="nx">tabs</span>
      <span class="nv">result = </span><span class="kc">yes</span>

</pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Try to find an existing tab.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">for</span> <span class="nx">tab</span> <span class="k">in</span> <span class="nx">tabs</span>
        <span class="k">if</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="o">is</span> <span class="mi">0</span>
          <span class="nv">existingTab = </span><span class="nx">tab</span>
          <span class="k">break</span>
      <span class="k">if</span> <span class="nx">existingTab</span><span class="o">?</span>

</pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>Found one! Now to select it.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="nx">chrome</span><span class="p">.</span><span class="nx">tabs</span><span class="p">.</span><span class="nx">update</span> <span class="nx">existingTab</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nv">active: </span><span class="kc">yes</span>
        <span class="nv">result = </span><span class="kc">no</span>
      <span class="k">else</span>

</pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Ach well, let's just create a new one.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="nx">chrome</span><span class="p">.</span><span class="nx">tabs</span><span class="p">.</span><span class="nx">create</span> <span class="nv">url: </span><span class="nx">url</span><span class="p">,</span> <span class="nv">active: </span><span class="kc">yes</span>
      <span class="nx">runner</span><span class="p">.</span><span class="nx">finish</span> <span class="nx">result</span>
    <span class="p">]</span>
  <span class="nx">runner</span><span class="p">.</span><span class="nx">run</span> <span class="nx">callback</span>


</pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Display a desktop notification informing the user on whether or not the copy
request was successful. <br />
Also, ensure that <code>ext</code> is <em>reset</em> and that notifications are only displayed
if the user has enabled the corresponding option (enabled by default).</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">showNotification = </span><span class="o">-&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;notifications.enabled&#39;</span>
    <span class="nx">webkitNotifications</span><span class="p">.</span><span class="nx">createHTMLNotification</span><span class="p">(</span>
      <span class="nx">utils</span><span class="p">.</span><span class="nx">url</span> <span class="s1">&#39;pages/notification.html&#39;</span>
    <span class="p">).</span><span class="nx">show</span><span class="p">()</span>
  <span class="k">else</span>
    <span class="nx">ext</span><span class="p">.</span><span class="nx">reset</span><span class="p">()</span>
  <span class="nx">updateProgress</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">off</span>


</pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Update the popup UI state to reflect the progress of the current request. <br />
Ignore <code>percent</code> if <code>toggle</code> is specified; otherwise update the percentage on
the progress bar and reset the delay timer. <br />
<code>toggle</code> can be used to show the progress bar or reset/close the popup.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">updateProgress = </span><span class="nf">(percent, toggle) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nv">popup       = </span><span class="nx">$</span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">extension</span><span class="p">.</span><span class="nx">getViews</span><span class="p">(</span><span class="nv">type: </span><span class="s1">&#39;popup&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nv">item        = </span><span class="k">if</span> <span class="nx">popup</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="nx">$</span> <span class="s1">&#39;#item&#39;</span><span class="p">,</span>    <span class="nx">popup</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">document</span> <span class="k">else</span> <span class="nx">$</span><span class="p">()</span>
  <span class="nv">loadDiv     = </span><span class="k">if</span> <span class="nx">popup</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="nx">$</span> <span class="s1">&#39;#loadDiv&#39;</span><span class="p">,</span> <span class="nx">popup</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nb">document</span> <span class="k">else</span> <span class="nx">$</span><span class="p">()</span>
  <span class="nv">progressBar = </span><span class="nx">loadDiv</span><span class="p">.</span><span class="nx">find</span> <span class="s1">&#39;.progress .bar&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Update the progress bar to display the specified <code>percent</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">if</span> <span class="nx">toggle</span><span class="o">?</span>
    <span class="k">if</span> <span class="nx">toggle</span>
      <span class="nx">progressBar</span><span class="p">.</span><span class="nx">css</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="s1">&#39;0%&#39;</span>
      <span class="nx">popup</span><span class="p">.</span><span class="nx">delay</span>          <span class="nx">POPUP_DELAY</span>
      <span class="nx">item</span><span class="p">.</span><span class="nx">hide</span><span class="p">().</span><span class="nx">delay</span>    <span class="nx">POPUP_DELAY</span>
      <span class="nx">loadDiv</span><span class="p">.</span><span class="nx">show</span><span class="p">().</span><span class="nx">delay</span> <span class="nx">POPUP_DELAY</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;toolbar.close&#39;</span>
        <span class="nx">popup</span><span class="p">.</span><span class="nx">queue</span> <span class="o">-&gt;</span> <span class="nx">popup</span><span class="p">.</span><span class="nx">dequeue</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="nx">loadDiv</span><span class="p">.</span><span class="nx">queue</span> <span class="o">-&gt;</span>
          <span class="nx">loadDiv</span><span class="p">.</span><span class="nx">hide</span><span class="p">().</span><span class="nx">dequeue</span><span class="p">()</span>
          <span class="nx">progressBar</span><span class="p">.</span><span class="nx">css</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="s1">&#39;0%&#39;</span>
        <span class="nx">item</span><span class="p">.</span><span class="nx">queue</span> <span class="o">-&gt;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">show</span><span class="p">().</span><span class="nx">dequeue</span><span class="p">()</span>
  <span class="k">else</span> <span class="k">if</span> <span class="nx">percent</span><span class="o">?</span>
    <span class="nx">popup</span><span class="p">.</span><span class="nx">dequeue</span><span class="p">().</span><span class="nx">delay</span>   <span class="nx">POPUP_DELAY</span>
    <span class="nx">item</span><span class="p">.</span><span class="nx">dequeue</span><span class="p">().</span><span class="nx">delay</span>    <span class="nx">POPUP_DELAY</span>
    <span class="nx">loadDiv</span><span class="p">.</span><span class="nx">dequeue</span><span class="p">().</span><span class="nx">delay</span> <span class="nx">POPUP_DELAY</span>
    <span class="nx">progressBar</span><span class="p">.</span><span class="nx">css</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="s2">&quot;#{percent}%&quot;</span>


</pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Update the statistical information.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">updateStatistics = </span><span class="o">-&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="s1">&#39;Updating statistics&#39;</span>
  <span class="nx">store</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;stats&#39;</span><span class="p">,</span> <span class="p">{}</span>
  <span class="nx">store</span><span class="p">.</span><span class="nx">modify</span> <span class="s1">&#39;stats&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">stats</span><span class="p">)</span> <span class="o">=&gt;</span>

</pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Determine which template has the greatest usage.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">maxUsage = </span><span class="mi">0</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">query</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">templates</span><span class="p">,</span> <span class="kc">no</span><span class="p">,</span> <span class="nf">(template) -&gt;</span>
      <span class="nv">maxUsage = </span><span class="nx">template</span><span class="p">.</span><span class="nx">usage</span> <span class="k">if</span> <span class="nx">template</span><span class="p">.</span><span class="nx">usage</span> <span class="o">&gt;</span> <span class="nx">maxUsage</span>
      <span class="kc">no</span>
    <span class="nv">popular = </span><span class="nx">ext</span><span class="p">.</span><span class="nx">queryTemplate</span> <span class="nf">(template) -&gt;</span> <span class="nx">template</span><span class="p">.</span><span class="nx">usage</span> <span class="o">is</span> <span class="nx">maxUsage</span>

</pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Calculate the up-to-date statistical information.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">stats.count       = </span><span class="nx">ext</span><span class="p">.</span><span class="nx">templates</span><span class="p">.</span><span class="nx">length</span>
    <span class="nv">stats.customCount = </span><span class="nx">stats</span><span class="p">.</span><span class="nx">count</span> <span class="o">-</span> <span class="nx">DEFAULT_TEMPLATES</span><span class="p">.</span><span class="nx">length</span>
    <span class="nv">stats.popular     = </span><span class="nx">popular</span><span class="o">?</span><span class="p">.</span><span class="nx">key</span>


</pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Increment the usage for the template with the specified <code>key</code> and persist the
changes.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">updateTemplateUsage = </span><span class="nf">(key) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="k">for</span> <span class="nx">template</span> <span class="k">in</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">templates</span> <span class="k">when</span> <span class="nx">template</span><span class="p">.</span><span class="nx">key</span> <span class="o">is</span> <span class="nx">key</span>
    <span class="nx">template</span><span class="p">.</span><span class="nx">usage</span><span class="o">++</span>
    <span class="k">break</span>
  <span class="nx">store</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;templates&#39;</span><span class="p">,</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">templates</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="s2">&quot;Used #{template.title} template&quot;</span>
  <span class="nx">analytics</span><span class="p">.</span><span class="nx">track</span> <span class="s1">&#39;Templates&#39;</span><span class="p">,</span> <span class="s1">&#39;Used&#39;</span><span class="p">,</span> <span class="nx">template</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nb">Number</span> <span class="nx">template</span><span class="p">.</span><span class="nx">readOnly</span>


</pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Increment the usage for the URL shortener service with the specified <code>name</code>
and persist the changes.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">updateUrlShortenerUsage = </span><span class="nf">(name, oauth) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nx">store</span><span class="p">.</span><span class="nx">modify</span> <span class="nx">name</span><span class="p">,</span> <span class="nf">(shortener) -&gt;</span> <span class="nx">shortener</span><span class="p">.</span><span class="nx">usage</span><span class="o">++</span>
  <span class="nv">shortener = </span><span class="nx">ext</span><span class="p">.</span><span class="nx">queryUrlShortener</span> <span class="nf">(shortener) -&gt;</span> <span class="nx">shortener</span><span class="p">.</span><span class="nx">name</span> <span class="o">is</span> <span class="nx">name</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="s2">&quot;Used #{shortener.title} URL shortener&quot;</span>
  <span class="nx">analytics</span><span class="p">.</span><span class="nx">track</span> <span class="s1">&#39;Shorteners&#39;</span><span class="p">,</span> <span class="s1">&#39;Used&#39;</span><span class="p">,</span> <span class="nx">shortener</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nb">Number</span> <span class="nx">oauth</span>


</pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <h2>Data functions</h2>             </td>             <td class="code">               <div class="highlight"><pre>


</pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Extract additional information from <code>tab</code> and add it to <code>data</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">addAdditionalData = </span><span class="nf">(tab, data, callback) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Create a runner to simplify this process.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">runner = </span><span class="k">new</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">Runner</span><span class="p">()</span>
  <span class="nx">runner</span><span class="p">.</span><span class="nx">push</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">geolocation</span><span class="p">,</span> <span class="s1">&#39;getCurrentPosition&#39;</span><span class="p">,</span> <span class="nf">(position) -&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s1">&#39;Retrieved the following geolocation information...&#39;</span><span class="p">,</span> <span class="nx">position</span>
    <span class="nv">coords = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">own</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">position</span><span class="p">.</span><span class="nx">coords</span>
      <span class="nx">coords</span><span class="p">[</span><span class="nx">prop</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()]</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">value</span><span class="o">?</span> <span class="k">then</span> <span class="s2">&quot;#{value}&quot;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">data</span><span class="p">,</span> <span class="nv">coords: </span><span class="nx">coords</span>
    <span class="nx">runner</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
  <span class="p">,</span> <span class="nf">(error) -&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">error</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span>
    <span class="nx">runner</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
  <span class="nx">runner</span><span class="p">.</span><span class="nx">push</span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">cookies</span><span class="p">,</span> <span class="s1">&#39;getAll&#39;</span><span class="p">,</span> <span class="nv">url: </span><span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nf">(cookies = []) -&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s1">&#39;Retrieved the followign cookies...&#39;</span><span class="p">,</span> <span class="nx">cookies</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">data</span><span class="p">,</span>
      <span class="nv">cookie: </span> <span class="o">-&gt;</span> <span class="nf">(text, render) -&gt;</span>

</pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Attempt to find the value for the cookie name.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="nv">name = </span><span class="nx">render</span> <span class="nx">text</span>
        <span class="k">return</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">value</span> <span class="k">for</span> <span class="nx">cookie</span> <span class="k">in</span> <span class="nx">cookies</span> <span class="k">when</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">name</span> <span class="o">is</span> <span class="nx">name</span>
        <span class="s1">&#39;&#39;</span>
      <span class="nv">cookies: </span><span class="p">(</span>
        <span class="nv">names = </span><span class="p">[]</span>
        <span class="k">for</span> <span class="nx">cookie</span> <span class="k">in</span> <span class="nx">cookies</span> <span class="k">when</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">name</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">names</span>
          <span class="nx">names</span><span class="p">.</span><span class="nx">push</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">name</span>
        <span class="nx">names</span>
      <span class="p">)</span>

</pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Try to prevent pages hanging because content script should not have been
executed.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">if</span> <span class="nx">isProtectedPage</span> <span class="nx">tab</span> <span class="k">then</span> <span class="nx">runner</span><span class="p">.</span><span class="nx">finish</span><span class="p">()</span> <span class="k">else</span> <span class="nx">runner</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
  <span class="nx">runner</span><span class="p">.</span><span class="nx">push</span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">tabs</span><span class="p">,</span> <span class="s1">&#39;sendRequest&#39;</span><span class="p">,</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">{},</span> <span class="nf">(response) -&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s1">&#39;Retrieved the following data from the content script...&#39;</span><span class="p">,</span>
      <span class="nx">response</span>
    <span class="nx">runner</span><span class="p">.</span><span class="nx">finish</span> <span class="nx">response</span>
  <span class="nx">runner</span><span class="p">.</span><span class="nx">run</span> <span class="nf">(result = {}) -&gt;</span>
    <span class="nv">lastModified = </span><span class="k">if</span> <span class="nx">result</span><span class="p">.</span><span class="nx">lastModified</span><span class="o">?</span>
      <span class="nv">time = </span><span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">result</span><span class="p">.</span><span class="nx">lastModified</span>
      <span class="k">new</span> <span class="nb">Date</span> <span class="nx">time</span> <span class="nx">unless</span> <span class="nb">isNaN</span> <span class="nx">time</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">data</span><span class="p">,</span>
      <span class="nv">author: </span>        <span class="nx">result</span><span class="p">.</span><span class="nx">author</span>        <span class="o">?</span> <span class="s1">&#39;&#39;</span>
      <span class="nv">characterset: </span>  <span class="nx">result</span><span class="p">.</span><span class="nx">characterSet</span>  <span class="o">?</span> <span class="s1">&#39;&#39;</span>
      <span class="nv">description: </span>   <span class="nx">result</span><span class="p">.</span><span class="nx">description</span>   <span class="o">?</span> <span class="s1">&#39;&#39;</span>
      <span class="nv">keywords: </span>      <span class="nx">result</span><span class="p">.</span><span class="nx">keywords</span>      <span class="o">?</span> <span class="p">[]</span>
      <span class="nv">lastmodified: </span>  <span class="o">-&gt;</span> <span class="nf">(text, render) -&gt;</span>
        <span class="nx">lastModified</span><span class="o">?</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">render</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="o">or</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span>
      <span class="nv">links: </span>         <span class="nx">result</span><span class="p">.</span><span class="nx">links</span>         <span class="o">?</span> <span class="p">[]</span>
      <span class="nv">pageheight: </span>    <span class="nx">result</span><span class="p">.</span><span class="nx">pageHeight</span>    <span class="o">?</span> <span class="s1">&#39;&#39;</span>
      <span class="nv">pagewidth: </span>     <span class="nx">result</span><span class="p">.</span><span class="nx">pageWidth</span>     <span class="o">?</span> <span class="s1">&#39;&#39;</span>
      <span class="nv">referrer: </span>      <span class="nx">result</span><span class="p">.</span><span class="nx">referrer</span>      <span class="o">?</span> <span class="s1">&#39;&#39;</span>
      <span class="nv">scripts: </span>       <span class="nx">result</span><span class="p">.</span><span class="nx">scripts</span>       <span class="o">?</span> <span class="p">[]</span>
      <span class="nv">selectedlinks: </span> <span class="nx">result</span><span class="p">.</span><span class="nx">selectedLinks</span> <span class="o">?</span> <span class="p">[]</span>
      <span class="nv">selection: </span>     <span class="nx">result</span><span class="p">.</span><span class="nx">selection</span>     <span class="o">?</span> <span class="s1">&#39;&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Deprecated since 1.0.0, use <code>selectedLinks</code> instead.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nv">selectionlinks: </span><span class="nx">result</span><span class="p">.</span><span class="nx">selectedLinks</span> <span class="o">?</span> <span class="p">[]</span>
      <span class="nv">stylesheets: </span>   <span class="nx">result</span><span class="p">.</span><span class="nx">styleSheets</span>   <span class="o">?</span> <span class="p">[]</span>
    <span class="nx">callback</span><span class="p">()</span>


</pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Creates an object containing data based on information derived from the
specified tab and menu item data.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">buildDerivedData = </span><span class="nf">(tab, onClickData, shortCallback) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nv">data =</span>
    <span class="nv">title: </span><span class="nx">tab</span><span class="p">.</span><span class="nx">title</span>
    <span class="nv">url: </span>  <span class="k">if</span> <span class="nx">onClickData</span><span class="p">.</span><span class="nx">linkUrl</span>
        <span class="nx">onClickData</span><span class="p">.</span><span class="nx">linkUrl</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">onClickData</span><span class="p">.</span><span class="nx">srcUrl</span>
        <span class="nx">onClickData</span><span class="p">.</span><span class="nx">srcUrl</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">onClickData</span><span class="p">.</span><span class="nx">frameUrl</span>
        <span class="nx">onClickData</span><span class="p">.</span><span class="nx">frameUrl</span>
      <span class="k">else</span>
        <span class="nx">onClickData</span><span class="p">.</span><span class="nx">pageUrl</span>
  <span class="nx">buildStandardData</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">shortCallback</span>


</pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>Construct a data object based on information extracted from <code>tab</code>. <br />
The tab information is then merged with additional information relating to
the URL of the tab. <br />
If a shortened URL is requested when parsing the templates contents later,
<code>shortCallback</code> is called to handle this as we don't want to call a URL
shortener service unless it is actually required.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">buildStandardData = </span><span class="nf">(tab, shortCallback) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nv">compatibility = </span><span class="kc">no</span>
  <span class="nv">data          = </span><span class="p">{}</span>
  <span class="nv">title         = </span><span class="s1">&#39;&#39;</span>
  <span class="nv">url           = </span><span class="p">{}</span>

</pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Check for any support extensions running on the current tab by simply
checking the tabs URL.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">for</span> <span class="nx">extension</span> <span class="k">in</span> <span class="nx">SUPPORT</span> <span class="k">when</span> <span class="nx">isExtensionActive</span> <span class="nx">tab</span><span class="p">,</span> <span class="nx">extension</span><span class="p">.</span><span class="nx">id</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;Making data compatible for #{exension.id}&quot;</span>
    <span class="nv">title         = </span><span class="nx">extension</span><span class="p">.</span><span class="nx">title</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">title</span>
    <span class="nv">url           = </span><span class="nx">$</span><span class="p">.</span><span class="nx">url</span> <span class="nx">extension</span><span class="p">.</span><span class="nx">url</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">url</span>
    <span class="nv">compatibility = </span><span class="kc">yes</span>
    <span class="k">break</span>

</pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Derive the initial data from the tab itself if no supported extensions were
found to be active.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nx">unless</span> <span class="nx">compatibility</span>
    <span class="nv">title = </span><span class="nx">tab</span><span class="p">.</span><span class="nx">title</span>
    <span class="nv">url   = </span><span class="nx">$</span><span class="p">.</span><span class="nx">url</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">url</span>

</pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Create references to the base of all grouped options to improve lookup
performance.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">anchor        = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;anchor&#39;</span>
  <span class="nv">bitly         = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;bitly&#39;</span>
  <span class="nv">googl         = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;googl&#39;</span>
  <span class="nv">menu          = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;menu&#39;</span>
  <span class="nv">notifications = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;notifications&#39;</span>
  <span class="nv">stats         = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;stats&#39;</span>
  <span class="nv">toolbar       = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;toolbar&#39;</span>
  <span class="nv">yourls        = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;yourls&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Merge the initial data with the attributes of the <a href="https://github.com/allmarkedup/jQuery-URL-Parser">URL
parser</a> and all of the
custom Template properties. <br />
All properties should be in lower case so that they can be looked up
ignoring case by our modified version of
<a href="https://github.com/janl/mustache.js">mustache.js</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">url</span><span class="p">.</span><span class="nx">attr</span><span class="p">(),</span>
    <span class="nv">anchortarget: </span>         <span class="nx">anchor</span><span class="p">.</span><span class="nx">target</span>
    <span class="nv">anchortitle: </span>          <span class="nx">anchor</span><span class="p">.</span><span class="nx">title</span>
    <span class="nv">bitly: </span>                <span class="nx">bitly</span><span class="p">.</span><span class="nx">enabled</span>
    <span class="nv">bitlyapikey: </span>          <span class="nx">bitly</span><span class="p">.</span><span class="nx">apiKey</span>
    <span class="nv">bitlyusername: </span>        <span class="nx">bitly</span><span class="p">.</span><span class="nx">username</span>
    <span class="nv">browser: </span>              <span class="nx">browser</span><span class="p">.</span><span class="nx">title</span>
    <span class="nv">browserversion: </span>       <span class="nx">browser</span><span class="p">.</span><span class="nx">version</span>

</pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Deprecated since 1.0.0, use <code>menu</code> instead.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">contextmenu: </span>          <span class="o">-&gt;</span> <span class="nx">@menu</span>
    <span class="nv">cookiesenabled: </span>       <span class="nx">navigator</span><span class="p">.</span><span class="nx">cookieEnabled</span>
    <span class="nv">count: </span>                <span class="nx">stats</span><span class="p">.</span><span class="nx">count</span>
    <span class="nv">customcount: </span>          <span class="nx">stats</span><span class="p">.</span><span class="nx">customCount</span>
    <span class="nv">datetime: </span>             <span class="o">-&gt;</span> <span class="nf">(text, render) -&gt;</span>
      <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">format</span><span class="p">(</span><span class="nx">render</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="o">or</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span>
    <span class="nv">decode: </span>               <span class="o">-&gt;</span> <span class="nf">(text, render) -&gt;</span>
      <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">render</span> <span class="nx">text</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span>
    <span class="nv">depth: </span>                <span class="nx">screen</span><span class="p">.</span><span class="nx">colorDepth</span>

</pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Deprecated since 1.0.0, use <code>anchorTarget</code> instead.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">doanchortarget: </span>       <span class="o">-&gt;</span> <span class="nx">@anchortarget</span>

</pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Deprecated since 1.0.0, use <code>anchorTitle</code> instead.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">doanchortitle: </span>        <span class="o">-&gt;</span> <span class="nx">@anchortitle</span>
    <span class="nv">encode: </span>               <span class="o">-&gt;</span> <span class="nf">(text, render) -&gt;</span>
      <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">render</span> <span class="nx">text</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Deprecated since 0.1.0.2, use <code>encode</code> instead.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">encoded: </span>              <span class="o">-&gt;</span> <span class="nb">encodeURIComponent</span> <span class="nx">@url</span>
    <span class="nv">favicon: </span>              <span class="nx">tab</span><span class="p">.</span><span class="nx">favIconUrl</span>
    <span class="nv">fparam: </span>               <span class="o">-&gt;</span> <span class="nf">(text, render) -&gt;</span>
      <span class="nx">url</span><span class="p">.</span><span class="nx">fparam</span><span class="p">(</span><span class="nx">render</span> <span class="nx">text</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span>
    <span class="nv">fparams: </span>              <span class="nx">nullIfEmpty</span> <span class="nx">url</span><span class="p">.</span><span class="nx">fparam</span><span class="p">()</span>
    <span class="nv">fsegment: </span>             <span class="o">-&gt;</span> <span class="nf">(text, render) -&gt;</span>
      <span class="nx">url</span><span class="p">.</span><span class="nx">fsegment</span><span class="p">(</span><span class="nb">parseInt</span> <span class="nx">render</span><span class="p">(</span><span class="nx">text</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span>
    <span class="nv">fsegments: </span>            <span class="nx">url</span><span class="p">.</span><span class="nx">fsegment</span><span class="p">()</span>
    <span class="nv">googl: </span>                <span class="nx">googl</span><span class="p">.</span><span class="nx">enabled</span>
    <span class="nv">googlaccount: </span>         <span class="o">-&gt;</span>
      <span class="nx">ext</span><span class="p">.</span><span class="nx">queryUrlShortener</span><span class="p">(</span><span class="nf">(shortener) -&gt;</span>
        <span class="nx">shortener</span><span class="p">.</span><span class="nx">name</span> <span class="o">is</span> <span class="s1">&#39;googl&#39;</span>
      <span class="p">).</span><span class="nx">oauth</span><span class="p">.</span><span class="nx">hasToken</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Deprecated since 1.0.0, use <code>googlAccount</code> instead.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">googloauth: </span>           <span class="o">-&gt;</span> <span class="nx">@googlaccount</span><span class="p">()</span>
    <span class="nv">java: </span>                 <span class="nx">navigator</span><span class="p">.</span><span class="nx">javaEnabled</span><span class="p">()</span>
    <span class="nv">menu: </span>                 <span class="nx">menu</span><span class="p">.</span><span class="nx">enabled</span>
    <span class="nv">menuoptions: </span>          <span class="nx">menu</span><span class="p">.</span><span class="nx">options</span>
    <span class="nv">notifications: </span>        <span class="nx">notifications</span><span class="p">.</span><span class="nx">enabled</span>
    <span class="nv">notificationduration: </span> <span class="nx">notifications</span><span class="p">.</span><span class="nx">duration</span> <span class="o">*</span> <span class="p">.</span><span class="mi">001</span>
    <span class="nv">offline: </span>              <span class="o">not</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">onLine</span>

</pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Deprecated since 0.1.0.2, use <code>originalUrl</code> instead.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">originalsource: </span>       <span class="o">-&gt;</span> <span class="nx">@originalurl</span>
    <span class="nv">originaltitle: </span>        <span class="nx">tab</span><span class="p">.</span><span class="nx">title</span> <span class="o">or</span> <span class="nx">url</span><span class="p">.</span><span class="nx">attr</span> <span class="s1">&#39;source&#39;</span>
    <span class="nv">originalurl: </span>          <span class="nx">tab</span><span class="p">.</span><span class="nx">url</span>
    <span class="nv">os: </span>                   <span class="nx">operatingSystem</span>
    <span class="nv">param: </span>                <span class="o">-&gt;</span> <span class="nf">(text, render) -&gt;</span>
      <span class="nx">url</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="nx">render</span> <span class="nx">text</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span>
    <span class="nv">params: </span>               <span class="nx">nullIfEmpty</span> <span class="nx">url</span><span class="p">.</span><span class="nx">param</span><span class="p">()</span>
    <span class="nv">plugins: </span>              <span class="p">(</span>
      <span class="nv">array   = </span><span class="p">[]</span>
      <span class="nv">plugins = </span><span class="p">(</span><span class="nx">plugin</span><span class="p">.</span><span class="nx">name</span> <span class="k">for</span> <span class="nx">plugin</span> <span class="k">in</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">plugins</span><span class="p">)</span>
      <span class="nx">plugins</span><span class="p">.</span><span class="nx">sort</span><span class="p">().</span><span class="nx">filter</span> <span class="nf">(name) -&gt;</span>
        <span class="k">if</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">array</span> <span class="k">then</span> <span class="kc">no</span> <span class="k">else</span>
          <span class="nx">array</span><span class="p">.</span><span class="nx">push</span> <span class="nx">name</span>
          <span class="kc">yes</span>
      <span class="nv">array = </span><span class="kc">null</span>
      <span class="nx">plugins</span>
    <span class="p">)</span>
    <span class="nv">popular: </span>              <span class="nx">ext</span><span class="p">.</span><span class="nx">queryTemplate</span> <span class="nf">(template) -&gt;</span>
      <span class="nx">template</span><span class="p">.</span><span class="nx">key</span> <span class="o">is</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">popular</span>
    <span class="nv">screenheight: </span>         <span class="nx">screen</span><span class="p">.</span><span class="nx">height</span>
    <span class="nv">screenwidth: </span>          <span class="nx">screen</span><span class="p">.</span><span class="nx">width</span>
    <span class="nv">segment: </span>              <span class="o">-&gt;</span> <span class="nf">(text, render) -&gt;</span>
      <span class="nx">url</span><span class="p">.</span><span class="nx">segment</span><span class="p">(</span><span class="nb">parseInt</span> <span class="nx">render</span><span class="p">(</span><span class="nx">text</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span>
    <span class="nv">segments: </span>             <span class="nx">url</span><span class="p">.</span><span class="nx">segment</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Deprecated since 1.0.0, use <code>shorten</code> instead.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">short: </span>                <span class="o">-&gt;</span> <span class="nx">@shorten</span><span class="p">()</span>
    <span class="nv">shortcuts: </span>            <span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;shortcuts&#39;</span>
    <span class="nv">shorten: </span>              <span class="o">-&gt;</span> <span class="nx">shortCallback</span>
    <span class="nv">title: </span>                <span class="nx">title</span> <span class="o">or</span> <span class="nx">url</span><span class="p">.</span><span class="nx">attr</span> <span class="s1">&#39;source&#39;</span>
    <span class="nv">toolbarclose: </span>         <span class="nx">toolbar</span><span class="p">.</span><span class="nx">close</span>

</pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Deprecated since 1.0.0, use the inverse of <code>toolbarPopup</code> instead.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">toolbarfeature: </span>       <span class="o">-&gt;</span> <span class="o">not</span> <span class="nx">@toolbarpopup</span>

</pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>Deprecated since 1.0.0, use <code>toolbarStyle</code> instead.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">toolbarfeaturedetails: </span><span class="o">-&gt;</span> <span class="nx">@toolbarstyle</span>

</pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>Deprecated since 1.0.0, use <code>toolbarKey</code> instead.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">toolbarfeaturename: </span>   <span class="o">-&gt;</span> <span class="nx">@toolbarkey</span>
    <span class="nv">toolbarkey: </span>           <span class="nx">toolbar</span><span class="p">.</span><span class="nx">key</span>
    <span class="nv">toolbaroptions: </span>       <span class="nx">toolbar</span><span class="p">.</span><span class="nx">options</span>
    <span class="nv">toolbarpopup: </span>         <span class="nx">toolbar</span><span class="p">.</span><span class="nx">popup</span>
    <span class="nv">toolbarstyle: </span>         <span class="nx">toolbar</span><span class="p">.</span><span class="nx">style</span>
    <span class="nv">url: </span>                  <span class="nx">url</span><span class="p">.</span><span class="nx">attr</span> <span class="s1">&#39;source&#39;</span>
    <span class="nv">version: </span>              <span class="nx">ext</span><span class="p">.</span><span class="nx">version</span>
    <span class="nv">yourls: </span>               <span class="nx">yourls</span><span class="p">.</span><span class="nx">enabled</span>
    <span class="nv">yourlspassword: </span>       <span class="nx">yourls</span><span class="p">.</span><span class="nx">password</span>
    <span class="nv">yourlssignature: </span>      <span class="nx">yourls</span><span class="p">.</span><span class="nx">signature</span>
    <span class="nv">yourlsurl: </span>            <span class="nx">yourls</span><span class="p">.</span><span class="nx">url</span>
    <span class="nv">yourlsusername: </span>       <span class="nx">yourls</span><span class="p">.</span><span class="nx">username</span>
  <span class="nx">data</span>


</pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Ensure there is a lower case variant of all properties of <code>data</code>, optionally
removing the original non-lower-case property.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">transformData = </span><span class="nf">(data, deleteOld) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="k">for</span> <span class="nx">own</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">data</span> <span class="k">when</span> <span class="nx">R_UPPER_CASE</span><span class="p">.</span><span class="nx">test</span> <span class="nx">prop</span>
    <span class="nx">data</span><span class="p">[</span><span class="nx">prop</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()]</span> <span class="o">=</span> <span class="nx">value</span>
    <span class="k">delete</span> <span class="nx">data</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="k">if</span> <span class="nx">deleteOld</span>


</pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <h2>HTML building functions</h2>             </td>             <td class="code">               <div class="highlight"><pre>


</pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>Build the HTML to populate the popup with to optimize popup loading times.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">buildPopup = </span><span class="o">-&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nv">item     = </span><span class="nx">$</span> <span class="s1">&#39;&lt;div id=&quot;item&quot;/&gt;&#39;</span>
  <span class="nv">itemList = </span><span class="nx">$</span> <span class="s1">&#39;&lt;ul id=&quot;itemList&quot;/&gt;&#39;</span>
  <span class="nv">loadDiv  = </span><span class="nx">$</span> <span class="s1">&#39;&lt;div id=&quot;loadDiv&quot;/&gt;&#39;</span>
  <span class="nx">loadDiv</span><span class="p">.</span><span class="nx">append</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;div/&gt;&#39;</span><span class="p">,</span>
    <span class="k">class</span><span class="o">:</span> <span class="s1">&#39;progress progress-info progress-striped active&#39;</span>
  <span class="p">).</span><span class="nx">append</span> <span class="nx">$</span> <span class="s1">&#39;&lt;div/&gt;&#39;</span><span class="p">,</span>
    <span class="k">class</span><span class="o">:</span> <span class="s1">&#39;bar&#39;</span>
    <span class="nv">style: </span><span class="s1">&#39;width: 100%&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>Generate the HTML for each template.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">for</span> <span class="nx">template</span> <span class="k">in</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">templates</span> <span class="k">when</span> <span class="nx">template</span><span class="p">.</span><span class="nx">enabled</span>
    <span class="nx">itemList</span><span class="p">.</span><span class="nx">append</span> <span class="nx">buildTemplate</span> <span class="nx">template</span>

</pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Add a generic message to state the obvious... that the list is empty.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">if</span> <span class="nx">itemList</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
    <span class="nx">itemList</span><span class="p">.</span><span class="nx">append</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;li/&gt;&#39;</span><span class="p">).</span><span class="nx">append</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;div/&gt;&#39;</span><span class="p">,</span>
      <span class="k">class</span><span class="o">:</span> <span class="s1">&#39;menu&#39;</span>
      <span class="nv">style: </span><span class="s2">&quot;background-image: url(&#39;../images/spacer.gif&#39;)&quot;</span>
    <span class="p">).</span><span class="nx">append</span> <span class="nx">$</span> <span class="s1">&#39;&lt;span/&gt;&#39;</span><span class="p">,</span>
      <span class="k">class</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span>
      <span class="nv">style: </span><span class="s1">&#39;margin-left: 0&#39;</span>
      <span class="nv">text: </span> <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;empty&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>Add a link to the options page if the user doesn't mind.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">if</span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;toolbar.options&#39;</span>
    <span class="nx">itemList</span><span class="p">.</span><span class="nx">append</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;li/&gt;&#39;</span><span class="p">,</span>
      <span class="k">class</span><span class="o">:</span>       <span class="s1">&#39;options&#39;</span>
      <span class="s1">&#39;data-type&#39;</span><span class="o">:</span> <span class="s1">&#39;options&#39;</span>
      <span class="nv">onclick: </span>    <span class="s1">&#39;popup.sendRequest(this)&#39;</span>
    <span class="p">).</span><span class="nx">append</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;div/&gt;&#39;</span><span class="p">,</span>
      <span class="k">class</span><span class="o">:</span> <span class="s1">&#39;menu&#39;</span>
      <span class="nv">style: </span><span class="s2">&quot;background-image: url(&#39;../images/tmpl_tools.png&#39;)&quot;</span>
    <span class="p">).</span><span class="nx">append</span> <span class="nx">$</span> <span class="s1">&#39;&lt;span/&gt;&#39;</span><span class="p">,</span>
      <span class="k">class</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span>
      <span class="nv">text: </span> <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;options&#39;</span>
  <span class="nx">item</span><span class="p">.</span><span class="nx">append</span> <span class="nx">itemList</span>
  <span class="nv">ext.popupHtml = </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;div/&gt;&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">loadDiv</span><span class="p">,</span> <span class="nx">item</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span>


</pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Create an <code>li</code> element to represent <code>template</code>. <br />
The element should then be inserted in to the <code>ul</code> element in the popup page
but is created here to optimize display times for the popup.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">buildTemplate = </span><span class="nf">(template) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;Creating popup list item for #{template.title}&quot;</span>
  <span class="nv">image = </span><span class="nx">getImagePathForTemplate</span> <span class="nx">template</span><span class="p">,</span> <span class="kc">yes</span>
  <span class="nv">item  = </span><span class="nx">$</span> <span class="s1">&#39;&lt;li/&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;data-key&#39;</span><span class="o">:</span>  <span class="nx">template</span><span class="p">.</span><span class="nx">key</span>
    <span class="s1">&#39;data-type&#39;</span><span class="o">:</span> <span class="s1">&#39;popup&#39;</span>
    <span class="nv">onclick: </span>    <span class="s1">&#39;popup.sendRequest(this)&#39;</span>
  <span class="nv">menu  = </span><span class="nx">$</span> <span class="s1">&#39;&lt;div/&gt;&#39;</span><span class="p">,</span>
    <span class="k">class</span><span class="o">:</span> <span class="s1">&#39;menu&#39;</span>
    <span class="nv">style: </span><span class="s2">&quot;background-image: url(&#39;#{image}&#39;)&quot;</span>
  <span class="nx">menu</span><span class="p">.</span><span class="nx">append</span> <span class="nx">$</span> <span class="s1">&#39;&lt;span/&gt;&#39;</span><span class="p">,</span>
    <span class="k">class</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span>
    <span class="nv">text: </span> <span class="nx">template</span><span class="p">.</span><span class="nx">title</span>
  <span class="k">if</span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;shortcuts&#39;</span>
    <span class="nv">modifiers = </span><span class="nx">ext</span><span class="p">.</span><span class="nx">SHORTCUT_MODIFIERS</span>
    <span class="nv">modifiers = </span><span class="nx">ext</span><span class="p">.</span><span class="nx">SHORTCUT_MAC_MODIFIERS</span> <span class="k">if</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">isThisPlatform</span> <span class="s1">&#39;mac&#39;</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">append</span> <span class="nx">$</span> <span class="s1">&#39;&lt;span/&gt;&#39;</span><span class="p">,</span>
      <span class="k">class</span><span class="o">:</span> <span class="s1">&#39;shortcut&#39;</span><span class="p">,</span>
      <span class="nv">html: </span> <span class="k">if</span> <span class="nx">template</span><span class="p">.</span><span class="nx">shortcut</span> <span class="k">then</span> <span class="nx">modifiers</span> <span class="o">+</span> <span class="nx">template</span><span class="p">.</span><span class="nx">shortcut</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
  <span class="nx">item</span><span class="p">.</span><span class="nx">append</span> <span class="nx">menu</span>


</pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <h2>Initialization functions</h2>             </td>             <td class="code">               <div class="highlight"><pre>


</pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>Handle the conversion/removal of older version of settings that may have been
stored previously by <code>ext.init</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">init_update = </span><span class="o">-&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>Update the update progress indicator itself.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">if</span> <span class="nx">store</span><span class="p">.</span><span class="nx">exists</span> <span class="s1">&#39;update_progress&#39;</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">modify</span> <span class="s1">&#39;updates&#39;</span><span class="p">,</span> <span class="nf">(updates) -&gt;</span>
      <span class="nv">progress = </span><span class="nx">store</span><span class="p">.</span><span class="nx">remove</span> <span class="s1">&#39;update_progress&#39;</span>
      <span class="k">for</span> <span class="nx">own</span> <span class="nx">namespace</span><span class="p">,</span> <span class="nx">versions</span> <span class="k">of</span> <span class="nx">progress</span>
        <span class="nx">updates</span><span class="p">[</span><span class="nx">namespace</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">versions</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="nx">versions</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>Create updater for the <code>settings</code> namespace.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">updater      = </span><span class="k">new</span> <span class="nx">store</span><span class="p">.</span><span class="nx">Updater</span> <span class="s1">&#39;settings&#39;</span>
  <span class="nv">isNewInstall = </span><span class="nx">updater</span><span class="p">.</span><span class="nx">isNew</span>

</pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>Define the processes for all required updates to the <code>settings</code>
namespace.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nx">updater</span><span class="p">.</span><span class="nx">update</span> <span class="s1">&#39;0.1.0.0&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="s1">&#39;Updating general settings for 0.1.0.0&#39;</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;settingNotification&#39;</span><span class="p">,</span>      <span class="s1">&#39;notifications&#39;</span><span class="p">,</span>        <span class="kc">on</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;settingNotificationTimer&#39;</span><span class="p">,</span> <span class="s1">&#39;notificationDuration&#39;</span><span class="p">,</span> <span class="mi">3000</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;settingShortcut&#39;</span><span class="p">,</span>          <span class="s1">&#39;shortcuts&#39;</span><span class="p">,</span>            <span class="kc">on</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;settingTargetAttr&#39;</span><span class="p">,</span>        <span class="s1">&#39;doAnchorTarget&#39;</span><span class="p">,</span>       <span class="kc">off</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;settingTitleAttr&#39;</span><span class="p">,</span>         <span class="s1">&#39;doAnchorTitle&#39;</span><span class="p">,</span>        <span class="kc">off</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">remove</span> <span class="s1">&#39;settingIeTabExtract&#39;</span><span class="p">,</span>      <span class="s1">&#39;settingIeTabTitle&#39;</span>
  <span class="nx">updater</span><span class="p">.</span><span class="nx">update</span> <span class="s1">&#39;1.0.0&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="s1">&#39;Updating general settings for 1.0.0&#39;</span>
    <span class="k">if</span> <span class="nx">store</span><span class="p">.</span><span class="nx">exists</span> <span class="s1">&#39;options_active_tab&#39;</span>
      <span class="nv">optionsActiveTab = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;options_active_tab&#39;</span>
      <span class="nx">store</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;options_active_tab&#39;</span><span class="p">,</span> <span class="k">switch</span> <span class="nx">optionsActiveTab</span>
        <span class="k">when</span> <span class="s1">&#39;features_nav&#39;</span> <span class="k">then</span> <span class="s1">&#39;templates_nav&#39;</span>
        <span class="k">when</span> <span class="s1">&#39;toolbar_nav&#39;</span> <span class="k">then</span> <span class="s1">&#39;general_nav&#39;</span>
        <span class="k">else</span> <span class="nx">optionsActiveTab</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">modify</span> <span class="s1">&#39;anchor&#39;</span><span class="p">,</span> <span class="nf">(anchor) -&gt;</span>
      <span class="nv">anchor.target = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;doAnchorTarget&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="kc">off</span>
      <span class="nv">anchor.title  = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;doAnchorTitle&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="kc">off</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">remove</span> <span class="s1">&#39;doAnchorTarget&#39;</span><span class="p">,</span> <span class="s1">&#39;doAnchorTitle&#39;</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">modify</span> <span class="s1">&#39;menu&#39;</span><span class="p">,</span> <span class="nf">(menu) -&gt;</span>
      <span class="nv">menu.enabled = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;contextMenu&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="kc">yes</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">remove</span> <span class="s1">&#39;contextMenu&#39;</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;notifications&#39;</span><span class="p">,</span>
      <span class="nv">duration: </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;notificationDuration&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3000</span>
      <span class="nv">enabled: </span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;notifications&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="kc">yes</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">remove</span> <span class="s1">&#39;notificationDuration&#39;</span>


</pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>Initialize the settings related to statistical information.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">initStatistics = </span><span class="o">-&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nx">updateStatistics</span><span class="p">()</span>


</pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>Initialize <code>template</code> and its properties, before adding it to <code>templates</code> to
be persisted later.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">initTemplate = </span><span class="nf">(template, templates) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>Derive the index of <code>template</code> to determine whether or not it already
exists.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">idx = </span><span class="nx">templates</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">query</span> <span class="nx">templates</span><span class="p">,</span> <span class="kc">yes</span><span class="p">,</span> <span class="nf">(tmpl) -&gt;</span>
    <span class="nx">tmpl</span><span class="p">.</span><span class="nx">key</span> <span class="o">is</span> <span class="nx">template</span><span class="p">.</span><span class="nx">key</span>
  <span class="k">if</span> <span class="nx">idx</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>

</pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p><code>template</code> doesn't already exist so add it now.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s1">&#39;Adding the following predefined template...&#39;</span><span class="p">,</span> <span class="nx">template</span>
    <span class="nx">templates</span><span class="p">.</span><span class="nx">push</span> <span class="nx">template</span>
  <span class="k">else</span>

</pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p><code>template</code> exists so modify the properties to ensure they are reliable.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s1">&#39;Ensuring following template adheres to structure...&#39;</span><span class="p">,</span> <span class="nx">template</span>
    <span class="k">if</span> <span class="nx">template</span><span class="p">.</span><span class="nx">readOnly</span>

</pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p><code>template</code> is read-only so certain properties should always be
overriden and others only when they are not already available.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">templates</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nv">content   = </span><span class="nx">template</span><span class="p">.</span><span class="nx">content</span>
      <span class="nx">templates</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">enabled</span>  <span class="o">?=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">enabled</span>
      <span class="nx">templates</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">image</span>    <span class="o">?=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">image</span>
      <span class="nx">templates</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">index</span>    <span class="o">?=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">index</span>
      <span class="nx">templates</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nv">key       = </span><span class="nx">template</span><span class="p">.</span><span class="nx">key</span>
      <span class="nx">templates</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nv">readOnly  = </span><span class="kc">yes</span>
      <span class="nx">templates</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">shortcut</span> <span class="o">?=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">shortcut</span>
      <span class="nx">templates</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nv">title     = </span><span class="nx">template</span><span class="p">.</span><span class="nx">title</span>
      <span class="nx">templates</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">usage</span>    <span class="o">?=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">usage</span>
    <span class="k">else</span>

</pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p><code>template</code> is <em>not</em> read-only so set unavailable, but required,
properties to their default value.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">templates</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">content</span>  <span class="o">?=</span> <span class="s1">&#39;&#39;</span>
      <span class="nx">templates</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">enabled</span>  <span class="o">?=</span> <span class="kc">yes</span>
      <span class="nx">templates</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">image</span>    <span class="o">?=</span> <span class="s1">&#39;&#39;</span>
      <span class="nx">templates</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">index</span>    <span class="o">?=</span> <span class="mi">0</span>
      <span class="nx">templates</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">key</span>      <span class="o">?=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">key</span>
      <span class="nx">templates</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nv">readOnly  = </span><span class="kc">no</span>
      <span class="nx">templates</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">shortcut</span> <span class="o">?=</span> <span class="s1">&#39;&#39;</span>
      <span class="nx">templates</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">title</span>    <span class="o">?=</span> <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;untitled&#39;</span>
      <span class="nx">templates</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">usage</span>    <span class="o">?=</span> <span class="mi">0</span>
    <span class="nv">template = </span><span class="nx">templates</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span>
  <span class="nx">template</span>


</pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>Initialize the persisted managed templates.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">initTemplates = </span><span class="o">-&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nx">initTemplates_update</span><span class="p">()</span>
  <span class="nx">store</span><span class="p">.</span><span class="nx">modify</span> <span class="s1">&#39;templates&#39;</span><span class="p">,</span> <span class="nf">(templates) -&gt;</span>

</pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>Initialize all default templates to ensure their properties are as
expected.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">initTemplate</span> <span class="nx">template</span><span class="p">,</span> <span class="nx">templates</span> <span class="k">for</span> <span class="nx">template</span> <span class="k">in</span> <span class="nx">DEFAULT_TEMPLATES</span>

</pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p>Now, initialize <em>all</em> templates to ensure their properties are valid.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">initTemplate</span> <span class="nx">template</span><span class="p">,</span> <span class="nx">templates</span> <span class="k">for</span> <span class="nx">template</span> <span class="k">in</span> <span class="nx">templates</span>
  <span class="nx">ext</span><span class="p">.</span><span class="nx">updateTemplates</span><span class="p">()</span>


</pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p>Handle the conversion/removal of older version of settings that may have been
stored previously by <code>initTemplates</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">initTemplates_update = </span><span class="o">-&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>Create updater for the <code>features</code> namespace and then rename it to
<code>templates</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">updater = </span><span class="k">new</span> <span class="nx">store</span><span class="p">.</span><span class="nx">Updater</span> <span class="s1">&#39;features&#39;</span>
  <span class="nx">updater</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;templates&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p>Define the processes for all required updates to the <code>templates</code> namespace.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nx">updater</span><span class="p">.</span><span class="nx">update</span> <span class="s1">&#39;0.1.0.0&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="s1">&#39;Updating template settings for 0.1.0.0&#39;</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyAnchorEnabled&#39;</span><span class="p">,</span>  <span class="s1">&#39;feat__anchor_enabled&#39;</span><span class="p">,</span>  <span class="kc">yes</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyAnchorOrder&#39;</span><span class="p">,</span>    <span class="s1">&#39;feat__anchor_index&#39;</span><span class="p">,</span>    <span class="mi">2</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyBBCodeEnabled&#39;</span><span class="p">,</span>  <span class="s1">&#39;feat__bbcode_enabled&#39;</span><span class="p">,</span>  <span class="kc">no</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyBBCodeOrder&#39;</span><span class="p">,</span>    <span class="s1">&#39;feat__bbcode_index&#39;</span><span class="p">,</span>    <span class="mi">4</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyEncodedEnabled&#39;</span><span class="p">,</span> <span class="s1">&#39;feat__encoded_enabled&#39;</span><span class="p">,</span> <span class="kc">yes</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyEncodedOrder&#39;</span><span class="p">,</span>   <span class="s1">&#39;feat__encoded_index&#39;</span><span class="p">,</span>   <span class="mi">3</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyShortEnabled&#39;</span><span class="p">,</span>   <span class="s1">&#39;feat__short_enabled&#39;</span><span class="p">,</span>   <span class="kc">yes</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyShortOrder&#39;</span><span class="p">,</span>     <span class="s1">&#39;feat__short_index&#39;</span><span class="p">,</span>     <span class="mi">1</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyUrlEnabled&#39;</span><span class="p">,</span>     <span class="s1">&#39;feat__url_enabled&#39;</span><span class="p">,</span>     <span class="kc">yes</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyUrlOrder&#39;</span><span class="p">,</span>       <span class="s1">&#39;feat__url_index&#39;</span><span class="p">,</span>       <span class="mi">0</span>
  <span class="nx">updater</span><span class="p">.</span><span class="nx">update</span> <span class="s1">&#39;0.2.0.0&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="s1">&#39;Updating template settings for 0.2.0.0&#39;</span>
    <span class="nv">names = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;features&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">names</span> <span class="k">when</span> <span class="k">typeof</span> <span class="nx">name</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
      <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s2">&quot;feat_#{name}_template&quot;</span><span class="p">,</span> <span class="s2">&quot;feat_#{name}_content&quot;</span>
      <span class="nv">image = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s2">&quot;feat_#{name}_image&quot;</span>
      <span class="k">switch</span> <span class="k">typeof</span> <span class="nx">image</span>
        <span class="k">when</span> <span class="s1">&#39;string&#39;</span>
          <span class="k">if</span> <span class="nx">image</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;spacer.gif&#39;</span><span class="p">,</span> <span class="s1">&#39;spacer.png&#39;</span><span class="p">]</span>
            <span class="nx">store</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;feat_#{name}_image&quot;</span><span class="p">,</span> <span class="mi">0</span>
          <span class="k">else</span>
            <span class="k">for</span> <span class="nx">img</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">IMAGES</span>
              <span class="nv">oldImg = </span><span class="nx">img</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/^tmpl/</span><span class="p">,</span> <span class="s1">&#39;feat&#39;</span>
              <span class="k">if</span> <span class="s2">&quot;#{oldImg}.png&quot;</span> <span class="o">is</span> <span class="nx">image</span>
                <span class="nx">store</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;feat_#{name}_image&quot;</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">break</span>
        <span class="k">else</span> <span class="nx">store</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;feat_#{name}_image&quot;</span><span class="p">,</span> <span class="mi">0</span>
  <span class="nx">updater</span><span class="p">.</span><span class="nx">update</span> <span class="s1">&#39;1.0.0&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="s1">&#39;Updating template settings for 1.0.0&#39;</span>
    <span class="nv">names              = </span><span class="nx">store</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s1">&#39;features&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="p">[]</span>
    <span class="nv">templates          = </span><span class="p">[]</span>
    <span class="nv">toolbarFeatureName = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;toolbarFeatureName&#39;</span>
    <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">names</span> <span class="k">when</span> <span class="k">typeof</span> <span class="nx">name</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
      <span class="nv">image = </span><span class="nx">store</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s2">&quot;feat_#{name}_image&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span>
      <span class="nx">image</span><span class="o">--</span>
      <span class="k">if</span> <span class="nx">image</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="nv">image = </span><span class="s1">&#39;&#39;</span>
      <span class="k">else</span>
        <span class="k">for</span> <span class="nx">img</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">IMAGES</span> <span class="k">when</span> <span class="nx">i</span> <span class="o">is</span> <span class="nx">image</span>
          <span class="nv">image = </span><span class="nx">img</span>
          <span class="k">break</span>
        <span class="nv">image = </span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">image</span> <span class="o">isnt</span> <span class="s1">&#39;string&#39;</span>
      <span class="nv">key = </span><span class="nx">ext</span><span class="p">.</span><span class="nx">getKeyForName</span> <span class="nx">name</span>
      <span class="k">if</span> <span class="nx">toolbarFeatureName</span> <span class="o">is</span> <span class="nx">name</span>
        <span class="k">if</span> <span class="nx">store</span><span class="p">.</span><span class="nx">exists</span> <span class="s1">&#39;toolbar&#39;</span>
          <span class="nx">store</span><span class="p">.</span><span class="nx">modify</span> <span class="s1">&#39;toolbar&#39;</span><span class="p">,</span> <span class="nf">(toolbar) -&gt;</span> <span class="nv">toolbar.key = </span><span class="nx">key</span>
        <span class="k">else</span>
          <span class="nx">store</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;toolbar&#39;</span><span class="p">,</span> <span class="nv">key: </span><span class="nx">key</span>
      <span class="nx">templates</span><span class="p">.</span><span class="nx">push</span>
        <span class="nv">content: </span> <span class="nx">store</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s2">&quot;feat_#{name}_content&quot;</span><span class="p">)</span>  <span class="o">?</span> <span class="s1">&#39;&#39;</span>
        <span class="nv">enabled: </span> <span class="nx">store</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s2">&quot;feat_#{name}_enabled&quot;</span><span class="p">)</span>  <span class="o">?</span> <span class="kc">yes</span>
        <span class="nv">image: </span>   <span class="nx">image</span>
        <span class="nv">index: </span>   <span class="nx">store</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s2">&quot;feat_#{name}_index&quot;</span><span class="p">)</span>    <span class="o">?</span> <span class="mi">0</span>
        <span class="nv">key: </span>     <span class="nx">key</span>
        <span class="nv">readOnly: </span><span class="nx">store</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s2">&quot;feat_#{name}_readonly&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="kc">no</span>
        <span class="nv">shortcut: </span><span class="nx">store</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s2">&quot;feat_#{name}_shortcut&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span>
        <span class="nv">title: </span>   <span class="nx">store</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s2">&quot;feat_#{name}_title&quot;</span><span class="p">)</span>    <span class="o">?</span> <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;untitled&#39;</span>
        <span class="nv">usage: </span>   <span class="mi">0</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;templates&#39;</span><span class="p">,</span> <span class="nx">templates</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">store</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span>
      <span class="sr">/^feat_.*_(content|enabled|image|index|readonly|shortcut|title)$/</span>
    <span class="p">)...</span>


</pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>Initialize the settings related to the toolbar/browser action.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">initToolbar = </span><span class="o">-&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nx">initToolbar_update</span><span class="p">()</span>
  <span class="nx">store</span><span class="p">.</span><span class="nx">modify</span> <span class="s1">&#39;toolbar&#39;</span><span class="p">,</span> <span class="nf">(toolbar) -&gt;</span>
    <span class="nx">toolbar</span><span class="p">.</span><span class="nx">close</span>   <span class="o">?=</span> <span class="kc">yes</span>
    <span class="nx">toolbar</span><span class="p">.</span><span class="nx">key</span>     <span class="o">?=</span> <span class="s1">&#39;PREDEFINED.00001&#39;</span>
    <span class="nx">toolbar</span><span class="p">.</span><span class="nx">options</span> <span class="o">?=</span> <span class="kc">yes</span>
    <span class="nx">toolbar</span><span class="p">.</span><span class="nx">popup</span>   <span class="o">?=</span> <span class="kc">yes</span>
    <span class="nx">toolbar</span><span class="p">.</span><span class="nx">style</span>   <span class="o">?=</span> <span class="kc">no</span>
  <span class="nx">ext</span><span class="p">.</span><span class="nx">updateToolbar</span><span class="p">()</span>


</pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>Handle the conversion/removal of older version of settings that may have been
stored previously by <code>initToolbar</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">initToolbar_update = </span><span class="o">-&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>Create updater for the <code>toolbar</code> namespace.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">updater = </span><span class="k">new</span> <span class="nx">store</span><span class="p">.</span><span class="nx">Updater</span> <span class="s1">&#39;toolbar&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>Define the processes for all required updates to the <code>toolbar</code> namespace.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nx">updater</span><span class="p">.</span><span class="nx">update</span> <span class="s1">&#39;1.0.0&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="s1">&#39;Updating toolbar settings for 1.0.0&#39;</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">modify</span> <span class="s1">&#39;toolbar&#39;</span><span class="p">,</span> <span class="nf">(toolbar) -&gt;</span>
      <span class="nv">toolbar.popup = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;toolbarPopup&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="kc">yes</span>
      <span class="nv">toolbar.style = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;toolbarFeatureDetails&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="kc">no</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">remove</span> <span class="s1">&#39;toolbarFeature&#39;</span><span class="p">,</span>     <span class="s1">&#39;toolbarFeatureDetails&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;toolbarFeatureName&#39;</span><span class="p">,</span> <span class="s1">&#39;toolbarPopup&#39;</span>


</pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>Initialize the settings related to the supported URL Shortener services.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">initUrlShorteners = </span><span class="o">-&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nx">store</span><span class="p">.</span><span class="nx">init</span>
    <span class="nv">bitly: </span> <span class="p">{}</span>
    <span class="nv">googl: </span> <span class="p">{}</span>
    <span class="nv">yourls: </span><span class="p">{}</span>
  <span class="nx">initUrlShorteners_update</span><span class="p">()</span>
  <span class="nx">store</span><span class="p">.</span><span class="nx">modify</span> <span class="s1">&#39;bitly&#39;</span><span class="p">,</span> <span class="nf">(bitly) -&gt;</span>
    <span class="nx">bitly</span><span class="p">.</span><span class="nx">apiKey</span>   <span class="o">?=</span> <span class="s1">&#39;&#39;</span>
    <span class="nx">bitly</span><span class="p">.</span><span class="nx">enabled</span>  <span class="o">?=</span> <span class="kc">no</span>
    <span class="nx">bitly</span><span class="p">.</span><span class="nx">usage</span>    <span class="o">?=</span> <span class="mi">0</span>
    <span class="nx">bitly</span><span class="p">.</span><span class="nx">username</span> <span class="o">?=</span> <span class="s1">&#39;&#39;</span>
  <span class="nx">store</span><span class="p">.</span><span class="nx">modify</span> <span class="s1">&#39;googl&#39;</span><span class="p">,</span> <span class="nf">(googl) -&gt;</span>
    <span class="nx">googl</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">?=</span> <span class="kc">yes</span>
    <span class="nx">googl</span><span class="p">.</span><span class="nx">usage</span>   <span class="o">?=</span> <span class="mi">0</span>
  <span class="nx">store</span><span class="p">.</span><span class="nx">modify</span> <span class="s1">&#39;yourls&#39;</span><span class="p">,</span> <span class="nf">(yourls) -&gt;</span>
    <span class="nx">yourls</span><span class="p">.</span><span class="nx">enabled</span>   <span class="o">?=</span> <span class="kc">no</span>
    <span class="nx">yourls</span><span class="p">.</span><span class="nx">password</span>  <span class="o">?=</span> <span class="s1">&#39;&#39;</span>
    <span class="nx">yourls</span><span class="p">.</span><span class="nx">signature</span> <span class="o">?=</span> <span class="s1">&#39;&#39;</span>
    <span class="nx">yourls</span><span class="p">.</span><span class="nx">url</span>       <span class="o">?=</span> <span class="s1">&#39;&#39;</span>
    <span class="nx">yourls</span><span class="p">.</span><span class="nx">username</span>  <span class="o">?=</span> <span class="s1">&#39;&#39;</span>
    <span class="nx">yourls</span><span class="p">.</span><span class="nx">usage</span>     <span class="o">?=</span> <span class="mi">0</span>


</pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p>Handle the conversion/removal of older version of settings that may have been
stored previously by <code>initUrlShorteners</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">initUrlShorteners_update = </span><span class="o">-&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>Create updater for the <code>shorteners</code> namespace.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">updater = </span><span class="k">new</span> <span class="nx">store</span><span class="p">.</span><span class="nx">Updater</span> <span class="s1">&#39;shorteners&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <p>Define the processes for all required updates to the <code>shorteners</code>
namespace.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nx">updater</span><span class="p">.</span><span class="nx">update</span> <span class="s1">&#39;0.1.0.0&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="s1">&#39;Updating URL shortener settings for 0.1.0.0&#39;</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;bitlyEnabled&#39;</span><span class="p">,</span>       <span class="s1">&#39;bitly&#39;</span><span class="p">,</span>         <span class="kc">off</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;bitlyXApiKey&#39;</span><span class="p">,</span>       <span class="s1">&#39;bitlyApiKey&#39;</span><span class="p">,</span>   <span class="s1">&#39;&#39;</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;bitlyXLogin&#39;</span><span class="p">,</span>        <span class="s1">&#39;bitlyUsername&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;googleEnabled&#39;</span><span class="p">,</span>      <span class="s1">&#39;googl&#39;</span><span class="p">,</span>         <span class="kc">on</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;googleOAuthEnabled&#39;</span><span class="p">,</span> <span class="s1">&#39;googlOAuth&#39;</span><span class="p">,</span>    <span class="kc">on</span>
  <span class="nx">updater</span><span class="p">.</span><span class="nx">update</span> <span class="s1">&#39;1.0.0&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="s1">&#39;Updating URL shortener settings for 1.0.0&#39;</span>
    <span class="nv">bitly = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;bitly&#39;</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;bitly&#39;</span><span class="p">,</span>
      <span class="nv">apiKey: </span>   <span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;bitlyApiKey&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span>
      <span class="nv">enabled: </span>  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">bitly</span> <span class="o">is</span> <span class="s1">&#39;boolean&#39;</span> <span class="k">then</span> <span class="nx">bitly</span> <span class="k">else</span> <span class="kc">no</span>
      <span class="nv">username: </span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;bitlyUsername&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">remove</span> <span class="s1">&#39;bitlyApiKey&#39;</span><span class="p">,</span> <span class="s1">&#39;bitlyUsername&#39;</span>
    <span class="nv">googl = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;googl&#39;</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;googl&#39;</span><span class="p">,</span>
      <span class="nv">enabled: </span><span class="k">if</span> <span class="k">typeof</span> <span class="nx">googl</span> <span class="o">is</span> <span class="s1">&#39;boolean&#39;</span> <span class="k">then</span> <span class="nx">googl</span> <span class="k">else</span> <span class="kc">yes</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">remove</span> <span class="s1">&#39;googlOAuth&#39;</span>
    <span class="nv">yourls = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;yourls&#39;</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;yourls&#39;</span><span class="p">,</span>
      <span class="nv">enabled: </span>  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">yourls</span> <span class="o">is</span> <span class="s1">&#39;boolean&#39;</span> <span class="k">then</span> <span class="nx">yourls</span> <span class="k">else</span> <span class="kc">no</span>
      <span class="nv">password: </span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;yourlsPassword&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span>
      <span class="nv">signature: </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;yourlsSignature&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span>
      <span class="nv">url: </span>      <span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;yourlsUrl&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span>
      <span class="nv">username: </span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;yourlsUsername&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">remove</span> <span class="s1">&#39;yourlsPassword&#39;</span><span class="p">,</span> <span class="s1">&#39;yourlsSignature&#39;</span><span class="p">,</span> <span class="s1">&#39;yourlsUrl&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;yourlsUsername&#39;</span>


</pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <h2>URL shortener functions</h2>             </td>             <td class="code">               <div class="highlight"><pre>


</pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <p>Call the active URL shortener service for each URL in <code>map</code> in order to
obtain their corresponding short URLs. <br />
<code>callback</code> will be called with the result once all URLs have been shortened
or an error is encountered.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">callUrlShortener = </span><span class="nf">(map, callback) -&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
  <span class="nv">service  = </span><span class="nx">getActiveUrlShortener</span><span class="p">()</span>
  <span class="nv">endpoint = </span><span class="nx">service</span><span class="p">.</span><span class="nx">url</span><span class="p">()</span>
  <span class="nv">title    = </span><span class="nx">service</span><span class="p">.</span><span class="nx">title</span>

</pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <p>Ensure the service URL exists in case it is user-defined (e.g. YOURLS).</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nx">unless</span> <span class="nx">endpoint</span>
    <span class="k">return</span> <span class="nx">callback</span>
      <span class="nv">message: </span><span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;shortener_config_error&#39;</span><span class="p">,</span> <span class="nx">title</span>
      <span class="nv">service: </span><span class="nx">service</span>
      <span class="nv">success: </span><span class="kc">no</span>

</pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <p>Create a runner to control the dependencies in the asynchronous processes.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">runner = </span><span class="k">new</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">Runner</span><span class="p">()</span>
  <span class="k">for</span> <span class="nx">own</span> <span class="nx">placeholder</span><span class="p">,</span> <span class="nx">url</span> <span class="k">of</span> <span class="nx">map</span>
    <span class="nx">do</span> <span class="nf">(placeholder, url) -&gt;</span> <span class="nx">runner</span><span class="p">.</span><span class="nx">push</span> <span class="kc">null</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nv">oauth  = </span><span class="o">!!</span><span class="nx">service</span><span class="p">.</span><span class="nx">oauth</span><span class="o">?</span><span class="p">.</span><span class="nx">hasToken</span><span class="p">()</span>
      <span class="nv">params = </span><span class="nx">service</span><span class="p">.</span><span class="nx">getParameters</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="o">or</span> <span class="p">{}</span>

</pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <p>Build the HTTP request for the URL shortener service.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nv">xhr = </span><span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">()</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span> <span class="nx">service</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="s2">&quot;#{endpoint}?#{$.param params}&quot;</span><span class="p">,</span> <span class="kc">yes</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span> <span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="nx">service</span><span class="p">.</span><span class="nx">contentType</span>

</pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <p>Setup OAuth for the request when required.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">if</span> <span class="nx">oauth</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span> <span class="s1">&#39;Authorization&#39;</span><span class="p">,</span>
          <span class="nx">service</span><span class="p">.</span><span class="nx">oauth</span><span class="p">.</span><span class="nx">getAuthorizationHeader</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">,</span>
            <span class="nx">service</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span>
      <span class="nv">xhr.onreadystatechange = </span><span class="o">-&gt;</span>

</pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <p>Wait for the response and let the service handle it before passing
the result to <code>callback</code> via the runner.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">if</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">is</span> <span class="mi">4</span>
          <span class="k">if</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">is</span> <span class="mi">200</span>
            <span class="nx">map</span><span class="p">[</span><span class="nx">placeholder</span><span class="p">]</span> <span class="o">=</span> <span class="nx">service</span><span class="p">.</span><span class="nx">output</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span>
            <span class="nx">runner</span><span class="p">.</span><span class="nx">next</span> <span class="nv">oauth: </span><span class="nx">oauth</span><span class="p">,</span> <span class="nv">success: </span><span class="kc">yes</span>
          <span class="k">else</span>

</pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <p>Something went wrong so let's tell the user.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="nx">runner</span><span class="p">.</span><span class="nx">finish</span>
              <span class="nv">message: </span><span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;shortener_detailed_error&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">title</span><span class="p">,</span> <span class="nx">url</span><span class="p">])</span>
              <span class="nv">success: </span><span class="kc">no</span>

</pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <p>Finally, send the HTTP request.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span> <span class="nx">service</span><span class="p">.</span><span class="nx">input</span> <span class="nx">url</span>
  <span class="nx">runner</span><span class="p">.</span><span class="nx">run</span> <span class="nf">(result = {}) -&gt;</span> <span class="nx">callback</span>
    <span class="nv">message: </span><span class="nx">result</span><span class="p">.</span><span class="nx">message</span>
    <span class="nv">oauth: </span>  <span class="nx">result</span><span class="p">.</span><span class="nx">oauth</span>
    <span class="nv">service: </span><span class="nx">service</span>
    <span class="nv">success: </span><span class="nx">result</span><span class="p">.</span><span class="nx">success</span>


</pre></div>             </td>           </tr>                               <tr id="section-138">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-138">&#182;</a>               </div>               <p>Retrieve the active URL shortener service.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">getActiveUrlShortener = </span><span class="o">-&gt;</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-139">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-139">&#182;</a>               </div>               <p>Attempt to lookup enabled URL shortener service.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">shortener = </span><span class="nx">ext</span><span class="p">.</span><span class="nx">queryUrlShortener</span> <span class="nf">(shortener) -&gt;</span> <span class="nx">shortener</span><span class="p">.</span><span class="nx">isEnabled</span><span class="p">()</span>
  <span class="nx">unless</span> <span class="nx">shortener</span><span class="o">?</span>

</pre></div>             </td>           </tr>                               <tr id="section-140">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-140">&#182;</a>               </div>               <p>Should never reach here but we'll return goo.gl service by default after
ensuring it's the active URL shortener service from now on to save some
time in the future.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">store</span><span class="p">.</span><span class="nx">modify</span> <span class="s1">&#39;googl&#39;</span><span class="p">,</span> <span class="nf">(googl) -&gt;</span> <span class="nv">googl.enabled = </span><span class="kc">yes</span>
    <span class="nv">shortener = </span><span class="nx">getActiveUrlShortener</span><span class="p">()</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;Getting details for #{shortener.title} URL shortener&quot;</span>
  <span class="nx">shortener</span>


</pre></div>             </td>           </tr>                               <tr id="section-141">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-141">&#182;</a>               </div>               <h2>Background page setup</h2>             </td>             <td class="code">               <div class="highlight"><pre>

<span class="nv">ext = </span><span class="nb">window</span><span class="p">.</span><span class="nv">ext = </span><span class="k">new</span> <span class="k">class</span> <span class="nx">Extension</span> <span class="k">extends</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">Class</span>


</pre></div>             </td>           </tr>                               <tr id="section-142">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-142">&#182;</a>               </div>               <h2>Public constants</h2>             </td>             <td class="code">               <div class="highlight"><pre>


</pre></div>             </td>           </tr>                               <tr id="section-143">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-143">&#182;</a>               </div>               <p>List of images available as template icons.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">IMAGES: </span><span class="p">[</span>
    <span class="s1">&#39;tmpl_auction&#39;</span><span class="p">,</span>         <span class="s1">&#39;tmpl_bug&#39;</span><span class="p">,</span>        <span class="s1">&#39;tmpl_clipboard&#39;</span>
    <span class="s1">&#39;tmpl_clipboard_empty&#39;</span><span class="p">,</span> <span class="s1">&#39;tmpl_component&#39;</span><span class="p">,</span>  <span class="s1">&#39;tmpl_cookies&#39;</span>
    <span class="s1">&#39;tmpl_discussion&#39;</span><span class="p">,</span>      <span class="s1">&#39;tmpl_globe&#39;</span><span class="p">,</span>      <span class="s1">&#39;tmpl_google&#39;</span>
    <span class="s1">&#39;tmpl_heart&#39;</span><span class="p">,</span>           <span class="s1">&#39;tmpl_html&#39;</span><span class="p">,</span>       <span class="s1">&#39;tmpl_key&#39;</span>
    <span class="s1">&#39;tmpl_lightbulb&#39;</span><span class="p">,</span>       <span class="s1">&#39;tmpl_lighthouse&#39;</span><span class="p">,</span> <span class="s1">&#39;tmpl_lightning&#39;</span>
    <span class="s1">&#39;tmpl_link&#39;</span><span class="p">,</span>            <span class="s1">&#39;tmpl_linux&#39;</span><span class="p">,</span>      <span class="s1">&#39;tmpl_mail&#39;</span>
    <span class="s1">&#39;tmpl_newspaper&#39;</span><span class="p">,</span>       <span class="s1">&#39;tmpl_note&#39;</span><span class="p">,</span>       <span class="s1">&#39;tmpl_page&#39;</span>
    <span class="s1">&#39;tmpl_plugin&#39;</span><span class="p">,</span>          <span class="s1">&#39;tmpl_rss&#39;</span><span class="p">,</span>        <span class="s1">&#39;tmpl_script&#39;</span>
    <span class="s1">&#39;tmpl_scull&#39;</span><span class="p">,</span>           <span class="s1">&#39;tmpl_sign&#39;</span><span class="p">,</span>       <span class="s1">&#39;tmpl_siren&#39;</span>
    <span class="s1">&#39;tmpl_star&#39;</span><span class="p">,</span>            <span class="s1">&#39;tmpl_support&#39;</span><span class="p">,</span>    <span class="s1">&#39;tmpl_tag&#39;</span>
    <span class="s1">&#39;tmpl_tags&#39;</span><span class="p">,</span>            <span class="s1">&#39;tmpl_thumb_down&#39;</span><span class="p">,</span> <span class="s1">&#39;tmpl_thumb_up&#39;</span>
    <span class="s1">&#39;tmpl_tools&#39;</span>
  <span class="p">]</span>


</pre></div>             </td>           </tr>                               <tr id="section-144">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-144">&#182;</a>               </div>               <p>String representation of the keyboard modifiers listened to by Template on
Windows/Linux platforms.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">SHORTCUT_MODIFIERS: </span><span class="s1">&#39;Ctrl+Alt+&#39;</span>


</pre></div>             </td>           </tr>                               <tr id="section-145">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-145">&#182;</a>               </div>               <p>String representation of the keyboard modifiers listened to by Template on
Mac platforms.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">SHORTCUT_MAC_MODIFIERS: </span><span class="s1">&#39;&amp;#8679;&amp;#8997;&#39;</span>


</pre></div>             </td>           </tr>                               <tr id="section-146">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-146">&#182;</a>               </div>               <h2>Public variables</h2>             </td>             <td class="code">               <div class="highlight"><pre>


</pre></div>             </td>           </tr>                               <tr id="section-147">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-147">&#182;</a>               </div>               <p>Information specifying what should be displaying in the notification. <br />
This should be reset after every copy request.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">notification:</span>
    <span class="nv">description: </span>     <span class="s1">&#39;&#39;</span>
    <span class="nv">descriptionStyle: </span><span class="s1">&#39;&#39;</span>
    <span class="nv">html: </span>            <span class="s1">&#39;&#39;</span>
    <span class="nv">icon: </span>            <span class="nx">utils</span><span class="p">.</span><span class="nx">url</span> <span class="s1">&#39;../images/icon_48.png&#39;</span>
    <span class="nv">iconStyle: </span>       <span class="s1">&#39;&#39;</span>
    <span class="nv">title: </span>           <span class="s1">&#39;&#39;</span>
    <span class="nv">titleStyle: </span>      <span class="s1">&#39;&#39;</span>


</pre></div>             </td>           </tr>                               <tr id="section-148">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-148">&#182;</a>               </div>               <p>Pre-prepared HTML for the popup to be populated using. <br />
This should be updated whenever templates are changed/updated in any way as
this is generated to improve performance and load times of the popup frame.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">popupHtml: </span><span class="s1">&#39;&#39;</span>


</pre></div>             </td>           </tr>                               <tr id="section-149">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-149">&#182;</a>               </div>               <p>Local copy of templates being used, ordered to match that specified by the
user.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">templates: </span><span class="p">[]</span>


</pre></div>             </td>           </tr>                               <tr id="section-150">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-150">&#182;</a>               </div>               <p>Current version of Template.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">version: </span><span class="s1">&#39;&#39;</span>


</pre></div>             </td>           </tr>                               <tr id="section-151">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-151">&#182;</a>               </div>               <h2>Public functions</h2>             </td>             <td class="code">               <div class="highlight"><pre>


</pre></div>             </td>           </tr>                               <tr id="section-152">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-152">&#182;</a>               </div>               <p>Add <code>str</code> to the system clipboard. <br />
All successful copy requests should, at some point, call this function. <br />
If <code>str</code> is empty the contents of the system clipboard will not change.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">copy: </span><span class="nf">(str, hidden) -&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
    <span class="nv">sandbox = </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#sandbox&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">str</span><span class="p">).</span><span class="nx">select</span><span class="p">()</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">execCommand</span> <span class="s1">&#39;copy&#39;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s1">&#39;Copied the following string...&#39;</span><span class="p">,</span> <span class="nx">str</span>
    <span class="nx">sandbox</span><span class="p">.</span><span class="nx">val</span> <span class="s1">&#39;&#39;</span>
    <span class="nx">showNotification</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">hidden</span>


</pre></div>             </td>           </tr>                               <tr id="section-153">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-153">&#182;</a>               </div>               <p>Attempt to retrieve the key of the template with the specified <code>name</code>. <br />
Since only the names of predefined templates are known, return a newly
generated key if it does not match any of their names.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">getKeyForName: </span><span class="nf">(name, generate = yes) -&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
    <span class="nv">key = </span><span class="k">switch</span> <span class="nx">name</span>
      <span class="k">when</span> <span class="s1">&#39;_url&#39;</span>      <span class="k">then</span> <span class="s1">&#39;PREDEFINED.00001&#39;</span>
      <span class="k">when</span> <span class="s1">&#39;_short&#39;</span>    <span class="k">then</span> <span class="s1">&#39;PREDEFINED.00002&#39;</span>
      <span class="k">when</span> <span class="s1">&#39;_anchor&#39;</span>   <span class="k">then</span> <span class="s1">&#39;PREDEFINED.00003&#39;</span>
      <span class="k">when</span> <span class="s1">&#39;_encoded&#39;</span>  <span class="k">then</span> <span class="s1">&#39;PREDEFINED.00004&#39;</span>
      <span class="k">when</span> <span class="s1">&#39;_bbcode&#39;</span>   <span class="k">then</span> <span class="s1">&#39;PREDEFINED.00005&#39;</span>
      <span class="k">when</span> <span class="s1">&#39;_markdown&#39;</span> <span class="k">then</span> <span class="s1">&#39;PREDEFINED.00006&#39;</span>
      <span class="k">else</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">keyGen</span><span class="p">()</span> <span class="k">if</span> <span class="nx">generate</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;Associating #{key} key with #{name} template&quot;</span>
    <span class="nx">key</span>


</pre></div>             </td>           </tr>                               <tr id="section-154">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-154">&#182;</a>               </div>               <p>Initialize the background page. <br />
This will involve initializing the settings and adding the request
listeners.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">init: </span><span class="o">-&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="s1">&#39;Initializing extension controller&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-155">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-155">&#182;</a>               </div>               <p>Add support for analytics if the user hasn't opted out.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">analytics</span><span class="p">.</span><span class="nx">add</span><span class="p">()</span> <span class="k">if</span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;analytics&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-156">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-156">&#182;</a>               </div>               <p>Begin initialization.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">store</span><span class="p">.</span><span class="nx">init</span>
      <span class="nv">anchor: </span>       <span class="p">{}</span>
      <span class="nv">menu: </span>         <span class="p">{}</span>
      <span class="nv">notifications: </span><span class="p">{}</span>
      <span class="nv">stats: </span>        <span class="p">{}</span>
      <span class="nv">templates: </span>    <span class="p">[]</span>
      <span class="nv">toolbar: </span>      <span class="p">{}</span>
    <span class="nx">init_update</span><span class="p">()</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">modify</span> <span class="s1">&#39;anchor&#39;</span><span class="p">,</span> <span class="nf">(anchor) -&gt;</span>
      <span class="nx">anchor</span><span class="p">.</span><span class="nx">target</span> <span class="o">?=</span> <span class="kc">off</span>
      <span class="nx">anchor</span><span class="p">.</span><span class="nx">title</span>  <span class="o">?=</span> <span class="kc">off</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">modify</span> <span class="s1">&#39;menu&#39;</span><span class="p">,</span> <span class="nf">(menu) -&gt;</span>
      <span class="nx">menu</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">?=</span> <span class="kc">yes</span>
      <span class="nx">menu</span><span class="p">.</span><span class="nx">options</span> <span class="o">?=</span> <span class="kc">yes</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">modify</span> <span class="s1">&#39;notifications&#39;</span><span class="p">,</span> <span class="nf">(notifications) -&gt;</span>
      <span class="nx">notifications</span><span class="p">.</span><span class="nx">duration</span> <span class="o">?=</span> <span class="mi">3000</span>
      <span class="nx">notifications</span><span class="p">.</span><span class="nx">enabled</span>  <span class="o">?=</span> <span class="kc">yes</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;shortcuts&#39;</span><span class="p">,</span> <span class="kc">on</span>
    <span class="nx">initTemplates</span><span class="p">()</span>
    <span class="nx">initToolbar</span><span class="p">()</span>
    <span class="nx">initStatistics</span><span class="p">()</span>
    <span class="nx">initUrlShorteners</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-157">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-157">&#182;</a>               </div>               <p>Add listener for toolbar/browser action clicks. <br />
This listener will be ignored whenever the popup is enabled.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">chrome</span><span class="p">.</span><span class="nx">browserAction</span><span class="p">.</span><span class="nx">onClicked</span><span class="p">.</span><span class="nx">addListener</span> <span class="nf">(tab) -&gt;</span> <span class="nx">onRequest</span>
      <span class="nv">data: key: </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;toolbar.key&#39;</span>
      <span class="nv">type: </span><span class="s1">&#39;toolbar&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-158">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-158">&#182;</a>               </div>               <p>Add listeners for internal and external requests.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">chrome</span><span class="p">.</span><span class="nx">extension</span><span class="p">.</span><span class="nx">onRequest</span><span class="p">.</span><span class="nx">addListener</span> <span class="nx">onRequest</span>
    <span class="nx">chrome</span><span class="p">.</span><span class="nx">extension</span><span class="p">.</span><span class="nx">onRequestExternal</span><span class="p">.</span><span class="nx">addListener</span> <span class="nf">(req, sender, cb) -&gt;</span>
      <span class="nv">block = </span><span class="nx">isBlacklisted</span> <span class="nx">sender</span><span class="p">.</span><span class="nx">id</span>
      <span class="nx">analytics</span><span class="p">.</span><span class="nx">track</span> <span class="s1">&#39;External Requests&#39;</span><span class="p">,</span> <span class="s1">&#39;Started&#39;</span><span class="p">,</span> <span class="nx">sender</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nb">Number</span> <span class="o">!</span><span class="nx">block</span>
      <span class="k">if</span> <span class="nx">block</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;Blocking external request from #{sender.id}&quot;</span>
        <span class="nx">cb</span><span class="o">?</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s2">&quot;Accepting external request from #{sender.id}&quot;</span>
        <span class="nx">onRequest</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">sender</span><span class="p">,</span> <span class="nx">cb</span>

</pre></div>             </td>           </tr>                               <tr id="section-159">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-159">&#182;</a>               </div>               <p>Derive the browser and OS information.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">browser.version = </span><span class="nx">getBrowserVersion</span><span class="p">()</span>
    <span class="nv">operatingSystem = </span><span class="nx">getOperatingSystem</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-160">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-160">&#182;</a>               </div>               <p>It's nice knowing what version is running.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s1">&#39;manifest.json&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="vi">@version = </span><span class="nx">data</span><span class="p">.</span><span class="nx">version</span>
      <span class="k">if</span> <span class="nx">isNewInstall</span>
        <span class="nx">analytics</span><span class="p">.</span><span class="nx">track</span> <span class="s1">&#39;Installs&#39;</span><span class="p">,</span> <span class="s1">&#39;New&#39;</span><span class="p">,</span> <span class="nx">@version</span><span class="p">,</span> <span class="nb">Number</span> <span class="nx">isProductionBuild</span>

</pre></div>             </td>           </tr>                               <tr id="section-161">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-161">&#182;</a>               </div>               <p>Execute content scripts now that we know the version.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">executeScriptsInExistingWindows</span><span class="p">()</span>


</pre></div>             </td>           </tr>                               <tr id="section-162">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-162">&#182;</a>               </div>               <p>Determine whether or not <code>os</code> matches the user's operating system.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">isThisPlatform: </span><span class="nf">(os) -&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
    <span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">os</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>


</pre></div>             </td>           </tr>                               <tr id="section-163">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-163">&#182;</a>               </div>               <p>Attempt to retrieve the contents of the system clipboard as a string.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">paste: </span><span class="o">-&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
    <span class="nv">result  = </span><span class="s1">&#39;&#39;</span>
    <span class="nv">sandbox = </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#sandbox&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">select</span><span class="p">()</span>
    <span class="nv">result  = </span><span class="nx">sandbox</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span> <span class="k">if</span> <span class="nb">document</span><span class="p">.</span><span class="nx">execCommand</span> <span class="s1">&#39;paste&#39;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span> <span class="s1">&#39;Pasted the following string...&#39;</span><span class="p">,</span> <span class="nx">result</span>
    <span class="nx">sandbox</span><span class="p">.</span><span class="nx">val</span> <span class="s1">&#39;&#39;</span>
    <span class="nx">result</span>


</pre></div>             </td>           </tr>                               <tr id="section-164">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-164">&#182;</a>               </div>               <p>Retrieve the first template that passes the specified <code>filter</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">queryTemplate: </span><span class="nf">(filter, singular = yes) -&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">query</span> <span class="nx">@templates</span><span class="p">,</span> <span class="nx">singular</span><span class="p">,</span> <span class="nx">filter</span>


</pre></div>             </td>           </tr>                               <tr id="section-165">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-165">&#182;</a>               </div>               <p>Retrieve the first URL shortener service that passes the specified
<code>filter</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">queryUrlShortener: </span><span class="nf">(filter, singular = yes) -&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">query</span> <span class="nx">SHORTENERS</span><span class="p">,</span> <span class="nx">singular</span><span class="p">,</span> <span class="nx">filter</span>


</pre></div>             </td>           </tr>                               <tr id="section-166">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-166">&#182;</a>               </div>               <p>Reset the notification information associated with the current copy
request. <br />
This should be called when a copy request is completed regardless of its
outcome.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">reset: </span><span class="o">-&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
    <span class="vi">@notification =</span>
      <span class="nv">description: </span>     <span class="s1">&#39;&#39;</span>
      <span class="nv">descriptionStyle: </span><span class="s1">&#39;&#39;</span>
      <span class="nv">html: </span>            <span class="s1">&#39;&#39;</span>
      <span class="nv">icon: </span>            <span class="nx">utils</span><span class="p">.</span><span class="nx">url</span> <span class="s1">&#39;../images/icon_48.png&#39;</span>
      <span class="nv">iconStyle: </span>       <span class="s1">&#39;&#39;</span>
      <span class="nv">title: </span>           <span class="s1">&#39;&#39;</span>
      <span class="nv">titleStyle: </span>      <span class="s1">&#39;&#39;</span>


</pre></div>             </td>           </tr>                               <tr id="section-167">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-167">&#182;</a>               </div>               <p>Update the context menu items to reflect the currently enabled templates. <br />
If the context menu option has been disabled by the user, just remove all
of the existing menu items.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">updateContextMenu: </span><span class="o">-&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-168">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-168">&#182;</a>               </div>               <p>Ensure that any previously added context menu items are removed.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">chrome</span><span class="p">.</span><span class="nx">contextMenus</span><span class="p">.</span><span class="nx">removeAll</span> <span class="o">=&gt;</span>

</pre></div>             </td>           </tr>                               <tr id="section-169">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-169">&#182;</a>               </div>               <p>Called whenever a template menu item is clicked. <br />
Send a self request, passing along the available information.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nv">onMenuClick = </span><span class="nf">(info, tab) -&gt;</span> <span class="nx">onRequest</span> <span class="nv">data: </span><span class="nx">info</span><span class="p">,</span> <span class="nv">type: </span><span class="s1">&#39;menu&#39;</span>
      <span class="nv">menu = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;menu&#39;</span>
      <span class="k">if</span> <span class="nx">menu</span><span class="p">.</span><span class="nx">enabled</span>

</pre></div>             </td>           </tr>                               <tr id="section-170">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-170">&#182;</a>               </div>               <p>Create and add the top-level Template menu.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="nv">parentId = </span><span class="nx">chrome</span><span class="p">.</span><span class="nx">contextMenus</span><span class="p">.</span><span class="nx">create</span>
          <span class="nv">contexts: </span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span>
          <span class="nv">title: </span>   <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;name&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-171">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-171">&#182;</a>               </div>               <p>Create and add a sub-menu item for each enabled template.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">for</span> <span class="nx">template</span> <span class="k">in</span> <span class="nx">@templates</span> <span class="k">when</span> <span class="nx">template</span><span class="p">.</span><span class="nx">enabled</span>
          <span class="nv">notEmpty = </span><span class="kc">yes</span>
          <span class="nv">menuId   = </span><span class="nx">chrome</span><span class="p">.</span><span class="nx">contextMenus</span><span class="p">.</span><span class="nx">create</span>
            <span class="nv">contexts: </span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span>
            <span class="nv">onclick: </span> <span class="nx">onMenuClick</span>
            <span class="nv">parentId: </span><span class="nx">parentId</span>
            <span class="nv">title: </span>   <span class="nx">template</span><span class="p">.</span><span class="nx">title</span>
          <span class="nv">template.menuId = </span><span class="nx">menuId</span>
        <span class="nx">unless</span> <span class="nx">notEmpty</span>
          <span class="nx">chrome</span><span class="p">.</span><span class="nx">contextMenus</span><span class="p">.</span><span class="nx">create</span>
            <span class="nv">contexts: </span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span>
            <span class="nv">parentId: </span><span class="nx">parentId</span>
            <span class="nv">title: </span>   <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;empty&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-172">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-172">&#182;</a>               </div>               <p>Add an item to open the options page if the user doesn't mind.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">if</span> <span class="nx">menu</span><span class="p">.</span><span class="nx">options</span>
          <span class="nx">chrome</span><span class="p">.</span><span class="nx">contextMenus</span><span class="p">.</span><span class="nx">create</span>
            <span class="nv">contexts: </span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span>
            <span class="nv">parentId: </span><span class="nx">parentId</span>
            <span class="nv">type: </span>    <span class="s1">&#39;separator&#39;</span>
          <span class="nx">chrome</span><span class="p">.</span><span class="nx">contextMenus</span><span class="p">.</span><span class="nx">create</span>
            <span class="nv">contexts: </span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span>
            <span class="nv">onclick: </span> <span class="nf">(info, tab) -&gt;</span> <span class="nx">onRequest</span> <span class="nv">type: </span><span class="s1">&#39;options&#39;</span>
            <span class="nv">parentId: </span><span class="nx">parentId</span>
            <span class="nv">title: </span>   <span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;options&#39;</span>


</pre></div>             </td>           </tr>                               <tr id="section-173">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-173">&#182;</a>               </div>               <p>Update the local list of templates to reflect those persisted. <br />
It is very important that this is called whenever templates may have been
changed in order to prepare the popup HTML and optimize performance.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">updateTemplates: </span><span class="o">-&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
    <span class="vi">@templates = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;templates&#39;</span>
    <span class="nx">@templates</span><span class="p">.</span><span class="nx">sort</span> <span class="nf">(a, b) -&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">index</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">index</span>
    <span class="nx">buildPopup</span><span class="p">()</span>
    <span class="nx">@updateContextMenu</span><span class="p">()</span>
    <span class="nx">updateStatistics</span><span class="p">()</span>


</pre></div>             </td>           </tr>                               <tr id="section-174">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-174">&#182;</a>               </div>               <p>Update the toolbar/browser action depending on the current settings.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">updateToolbar: </span><span class="o">-&gt;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">trace</span><span class="p">()</span>
    <span class="nv">image    = </span><span class="s1">&#39;images/icon_19.png&#39;</span>
    <span class="nv">key      = </span><span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;toolbar.key&#39;</span>
    <span class="nv">template = </span><span class="nx">getTemplateWithKey</span> <span class="nx">key</span> <span class="k">if</span> <span class="nx">key</span>
    <span class="nv">title    = </span><span class="nx">i18n</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;name&#39;</span>
    <span class="nx">buildPopup</span><span class="p">()</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">template</span> <span class="o">or</span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;toolbar.popup&#39;</span>
      <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="s1">&#39;Configuring toolbar to display popup&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-175">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-175">&#182;</a>               </div>               <p>Use Template's details to style the browser action.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">chrome</span><span class="p">.</span><span class="nx">browserAction</span><span class="p">.</span><span class="nx">setIcon</span>  <span class="nv">path: </span> <span class="nx">utils</span><span class="p">.</span><span class="nx">url</span> <span class="nx">image</span>
      <span class="nx">chrome</span><span class="p">.</span><span class="nx">browserAction</span><span class="p">.</span><span class="nx">setTitle</span> <span class="nv">title: </span><span class="nx">title</span>

</pre></div>             </td>           </tr>                               <tr id="section-176">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-176">&#182;</a>               </div>               <p>Show the popup when the browser action is clicked.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">chrome</span><span class="p">.</span><span class="nx">browserAction</span><span class="p">.</span><span class="nx">setPopup</span> <span class="nv">popup: </span><span class="s1">&#39;pages/popup.html&#39;</span>
    <span class="k">else</span>
      <span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="s1">&#39;Configuring toolbar to activate specified template&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-177">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-177">&#182;</a>               </div>               <p>Replace Template's details with that of the selected template.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">if</span> <span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;toolbar.style&#39;</span>
        <span class="nv">image = </span><span class="nx">getImagePathForTemplate</span> <span class="nx">template</span> <span class="k">if</span> <span class="nx">template</span><span class="p">.</span><span class="nx">image</span> <span class="o">isnt</span> <span class="mi">0</span>
        <span class="nv">title = </span><span class="nx">template</span><span class="p">.</span><span class="nx">title</span>

</pre></div>             </td>           </tr>                               <tr id="section-178">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-178">&#182;</a>               </div>               <p>Potentially change the style of the browser action.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">chrome</span><span class="p">.</span><span class="nx">browserAction</span><span class="p">.</span><span class="nx">setIcon</span>  <span class="nv">path: </span> <span class="nx">utils</span><span class="p">.</span><span class="nx">url</span> <span class="nx">image</span>
      <span class="nx">chrome</span><span class="p">.</span><span class="nx">browserAction</span><span class="p">.</span><span class="nx">setTitle</span> <span class="nv">title: </span><span class="nx">title</span>

</pre></div>             </td>           </tr>                               <tr id="section-179">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-179">&#182;</a>               </div>               <p>Disable the popup, effectively enabling the listener for
<code>chrome.browserAction.onClicked</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">chrome</span><span class="p">.</span><span class="nx">browserAction</span><span class="p">.</span><span class="nx">setPopup</span> <span class="nv">popup: </span><span class="s1">&#39;&#39;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 